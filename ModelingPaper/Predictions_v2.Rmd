---
title: "Predictions"
output: html_document
---

Import and clean data

```{r}

# import data

library(ggplot2)
library(tidyverse)
library(dplyr)
library(rgdal)
library(raster)
library(sf)
library(sp)
library(leaps)
library(viridis)
library(spatial)
library(spdep)
library(plm)
library(stringr)

os_system <- 'windows' # mac for laptop or windows for desktop
if (os_system == 'windows') {first_folder <- 'E:'}
if (os_system == 'mac') {first_folder <- '~/Documents'}
if (os_system == 'windows_laptop') {first_folder <- 'D:'}

#E:/R-code/Modeling/code/FCN_clean_csvs.R
#~/Documents/R-code
source(paste0(first_folder,'/R-code2/Modeling/code/FCN_clean_csvs.R'))
source(paste0(first_folder,'/R-code2/Modeling/code/FCN_plotting.R'))
source(paste0(first_folder,'/R-code2/Modeling/code/FCN_sample_data.R'))
source(paste0(first_folder,'/R-code2/Modeling/code/FCN_run_model_spatial_sampled.R'))


MT_outline <- readOGR(dsn = paste0(first_folder,'/R-code2/Modeling/data/shp/MatoGrossoOutline'), layer = 'MatoGrossoOutline')
crs(MT_outline) <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")

```

```{r}
onset_oi <- 'demise_AA_25_persiann' #'freq_8_chirps_ATchirps5km' #'freq_10_persiann'

# FOR onset_oi ------------------------------------------------------------------------------------------------------------------------
# read and clean the data ---------------------------------------------------------------------------------------------------------
filename_median <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi, '/median_onset_cell_onset_', onset_oi , '.csv')
filename_percentile5 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi , '/percentile5_onset_cell_onset_', onset_oi , '.csv')
filename_percentile25 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi , '/percentile25_onset_cell_onset_', onset_oi , '.csv')
filename_percentile75 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi, 
                                  '/percentile75_onset_cell_onset_', onset_oi, '.csv')
filename_percentile95 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi, 
                                  '/percentile95_onset_cell_onset_', onset_oi, '.csv')

filename_shp<- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi , '/shp')
layername_shp <- paste0('median_onset_cell_SHP_onset_', onset_oi )
    
median_cell_raw <- read.csv(filename_median)
percentile5_cell_raw <- read.csv(filename_percentile5)
percentile25_cell_raw <- read.csv(filename_percentile25)
percentile75_cell_raw <- read.csv(filename_percentile75)
percentile95_cell_raw <- read.csv(filename_percentile95)

cell_sf <- st_read(dsn = filename_shp, layer = layername_shp)
 
# CSV DATA -----------------------------------------------------------------------------------------------
# median cell
median_cell <- median_cell_raw %>% delete_cols_median_cell() %>%
                                      rename_cols_median_cell()
median_cell$plant_stat_type <- rep('median', nrow(median_cell))
median_cell <- median_cell %>% rename(demise = demise_median) %>% dplyr::select(-demise_sum)
  
# percentiles
percentile5_cell <- percentile5_cell_raw %>% rename_cols_percentile_cell() 
percentile25_cell <- percentile25_cell_raw %>% rename_cols_percentile_cell() 
percentile75_cell <- percentile75_cell_raw %>% rename_cols_percentile_cell() 
percentile95_cell <- percentile95_cell_raw %>% rename_cols_percentile_cell()
  
# SF DATA ------------------------------------------------------------------------------------------------
  
# get cell_ID column for median
cell_sf$cell_ID <- median_cell$cell_ID
cell_sf$cell_ID <- sapply(as.character(cell_sf$cell_ID), clean_cell_ID)
  
# join median, percentile data to cell_sf
# cell_sf has median information, but copy it and put in percentile info for DC and SC plant
  
cell_sf$plant_stat_type <- rep("median", nrow(cell_sf))
cell_sf$demise <- median_cell$demise
  
cell_sf_percentile5 <- cell_sf
cell_sf_percentile5$SC_plant <- percentile5_cell$SC_plant
cell_sf_percentile5$DC_plant <- percentile5_cell$DC_plant
cell_sf_percentile5$plant_stat_type <- rep("percentile5", nrow(cell_sf_percentile5))
  
cell_sf_percentile25 <- cell_sf
cell_sf_percentile25$SC_plant <- percentile25_cell$SC_plant
cell_sf_percentile25$DC_plant <- percentile25_cell$DC_plant
cell_sf_percentile25$plant_stat_type <- rep("percentile25", nrow(cell_sf_percentile25))

cell_sf_percentile75 <- cell_sf
cell_sf_percentile75$SC_plant <- percentile75_cell$SC_plant
cell_sf_percentile75$DC_plant <- percentile75_cell$DC_plant
cell_sf_percentile75$plant_stat_type <- rep("percentile75", nrow(cell_sf_percentile75))

cell_sf_percentile95 <- cell_sf
cell_sf_percentile95$SC_plant <- percentile95_cell$SC_plant
cell_sf_percentile95$DC_plant <- percentile95_cell$DC_plant
cell_sf_percentile95$plant_stat_type <- rep("percentile95", nrow(cell_sf_percentile95))

cell_sf <- rbind(cell_sf, cell_sf_percentile5, cell_sf_percentile25, cell_sf_percentile75, cell_sf_percentile95)
  
cell_sf_tidy <- cell_sf %>% tidy_by_intensity_plant("SC_plant", "DC_plant") %>%
            dplyr::select(-c(SC_harvest, DC_harvest)) %>%
            categorize_regions_cell_sf_tidy() # categorize cells into four regions
  
cell_sf_tidy$year_index <- cell_sf_tidy$year - 2003
cell_sf_tidy$year_factor <- as.factor(cell_sf_tidy$year)
  
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy$delay <- cell_sf_tidy$plant - cell_sf_tidy$onset

# change 'median' to 'percentile50'
cell_df <- cell_sf_tidy
st_geometry(cell_df) <- NULL
cell_df[which(cell_df[,"plant_stat_type"] == "median"), "plant_stat_type"] <- "percentile50"

cell_sf_tidy$percentile <- cell_df$plant_stat_type
```

Given a year and region, plot planting date CDF and make predictions from it

```{r}

year_oi <- 2014 # AVOID USING THIS FOR 2004 - 2014 AVERAGE

# onset regions and change

# 10th percentile: vulnerable = -10; no vulnerable = -5
# 50th percentile: vulnerable = 5; not vulnerable = 3
# 90th percentile: vulnerable = 20; not vulnerable = 13
case_name <- 'lateOn_earlyDem' # CHANGE THIS
onset_change_vulnerable <- 20.92 # CHANGE THIS
onset_change_not_vulnerable <- 13.64 # CHANGE THIS
demise_change_vulnerable <- -26.42 # CHANGE THIS
demise_change_not_vulnerable <- -22.83 # CHANGE THIS

region_cutoff <- -54 # longitude; to the west, 'not_vulnerable' and to the east, 'vulnerable'

SC_cycle_length <- 90
DC_cycle_length <- 200
year_change <- 10 # number of years after year_oi for prediction

cell_df <- cell_sf_tidy
st_geometry(cell_df) <- NULL

if (onset_oi == 'demise_AA_25_persiann') {
  coefs_onset_oi <- readRDS("FE_bootstrapped_coefs_AA_25_persiann.rds")
}

if (onset_oi == 'freq_10_persiann') {
  coefs_onset_oi <- readRDS("FE_bootstrapped_coefs_freq_10_persiann.rds")
}

if (onset_oi == 'freq_8_chirps_ATchirps5km') {
  coefs_onset_oi <- readRDS("FE_bootstrapped_coefs_freq_8_chirps_ATchirps5km.rds")
}

coefs_onset_oi$percentile <- as.character(coefs_onset_oi$percentile)
coefs_onset_oi[which(coefs_onset_oi[,"percentile"] == "median"), "percentile"] <- "percentile50"

# to store mean 'change in planting date' per 25km cell. 
predictions_summary <- data.frame(intensity = character(0),
                                  region = character(0),
                                  pred_type = character(0),
                                  # the average number of days planting is delayed in a 25km cell. 
                                  # NOTE: THESE PREDICTIONS for change_plant ARE ASSUMING THERE'S NO IMPACT OF ONSET TIMING ON PLANTING DATE
                                  change_plant = numeric(0), 
                                  # the percent of the 25km cell that is affected by late onset (i.e. can't plant as early as they otherwise would)
                                  percent_affected_late_onset = numeric(0),
                                  # percent of people who won't be able to do DC (or SC) due to earlier demise
                                  percent_affected_early_demise = numeric(0),
                                  # available days to plant the given intensity
                                  window = numeric(0))

for (intensity in c('SC', 'DC')) {
  for (region in c('vulnerable', 'not_vulnerable')) {
    
    # to store observations and predictions in CDF form
    predictions <- data.frame(percentile = numeric(0),
                              plant = numeric(0),
                              type = character(0))
    
    if (region == 'vulnerable') {
      cell_df_subset <- cell_df[cell_df$year == year_oi & cell_df$intensity == intensity & cell_df$lon > region_cutoff,] # east # cell_df$year == year_oi & 
      onset_change <- onset_change_vulnerable
      demise_change <- demise_change_vulnerable
    }
    
    if (region == 'not_vulnerable') {
      cell_df_subset <- cell_df[cell_df$year == year_oi & cell_df$intensity == intensity & cell_df$lon <= region_cutoff,] # west # cell_df$year == year_oi & 
      onset_change <- onset_change_not_vulnerable
      demise_change <- demise_change_not_vulnerable
    }
    
    obs_onset <- mean(cell_df_subset$onset)
    pred_onset <- obs_onset + onset_change
    obs_demise <- mean(cell_df_subset$demise)
    pred_demise <- obs_demise + demise_change
    

    
    # calculate latest planting date based on cropping intensity
    if (intensity == 'SC') {
      pred_latest_plant <- pred_demise + 30 - SC_cycle_length # assume use 20 days of soil moisture and 10 days for grain drying
      obs_latest_plant <- obs_demise + 30 - SC_cycle_length
    }
    
    if (intensity == 'DC') {
      pred_latest_plant <- pred_demise + 30 - DC_cycle_length
      obs_latest_plant <- obs_demise + 30 - DC_cycle_length
    }
  
    for (percentile in c('percentile5', 'percentile25', 'percentile50', 'percentile75', 'percentile95')) {
      
      percentile_int <-  strtoi(str_remove(percentile, 'percentile'))
      
      # take average of each percentile observed in the region x year
      mean_observed <- mean(cell_df_subset[cell_df_subset$percentile == percentile, 'plant'])
      
      # predictions
      plant_pred_onset_change <- mean_observed + onset_change*coefs_onset_oi[coefs_onset_oi$intensity == intensity &
                                                                                       coefs_onset_oi$percentile == percentile, "onset_coef"]
      plant_pred_onset_year_change <- mean_observed + onset_change*coefs_onset_oi[coefs_onset_oi$intensity == intensity &
                                                                                       coefs_onset_oi$percentile == percentile, "onset_coef"] +
                                                      year_change*coefs_onset_oi[coefs_onset_oi$intensity == intensity &
                                                                                       coefs_onset_oi$percentile == percentile, "year_coef"]
      
      # to store originals and predictions
      predictions <- rbind(predictions, 
                           data.frame(
                             percentile = rep(percentile_int, 3),
                             plant = c(mean_observed, plant_pred_onset_change, plant_pred_onset_year_change),
                             type = c('observed', 'pred_onset_change', 'pred_onset_year_change')
                             )
                           )
    }
    
    #get observations
    observations <- predictions[predictions$type == 'observed',]
    percentile5_obs <- observations[observations$percentile == 5, 'plant']
    percentile25_obs <- observations[observations$percentile == 25, 'plant']
    percentile50_obs <- observations[observations$percentile == 50, 'plant']
    percentile75_obs <- observations[observations$percentile == 75, 'plant']
    percentile95_obs <- observations[observations$percentile == 95, 'plant']
    
    print(paste(intensity, region))
    print('observed planting window')
    print(percentile95_obs - percentile5_obs)
      
    # calculate number of days available for planting
    window <- max(0, pred_latest_plant - pred_onset) # if latest plant is before onset, window = 0
    
    # calculate change in plant
    for (pred_type in c('pred_onset_change', 'pred_onset_year_change')) {
      predictions_pred_type <- predictions[predictions$type == pred_type,]

      # get predictions
      percentile5_pred <- predictions_pred_type[predictions_pred_type$percentile == 5, 'plant']
      percentile25_pred <- predictions_pred_type[predictions_pred_type$percentile == 25, 'plant']
      percentile50_pred <- predictions_pred_type[predictions_pred_type$percentile == 50, 'plant']
      percentile75_pred <- predictions_pred_type[predictions_pred_type$percentile == 75, 'plant']
      percentile95_pred <- predictions_pred_type[predictions_pred_type$percentile == 95, 'plant']
      
      # calculate area (in planting date)
      area <- 0.2*((percentile95_pred - percentile95_obs) + (percentile75_pred - percentile75_obs))/2 +
            0.25*((percentile75_pred - percentile75_obs) + (percentile50_pred - percentile50_obs))/2 +
            0.25*((percentile50_pred - percentile50_obs) + (percentile25_pred - percentile25_obs))/2 +
            0.2*((percentile25_pred - percentile25_obs) + (percentile5_pred - percentile5_obs))/2
      
      # percent people who need to plant later due to delayed onset
      if (pred_onset <= percentile5_pred) {
        percent_affect_late_onset <- 0
      }
      else {
        percent_affect_late_onset <- approx(c(percentile5_pred, percentile25_pred, percentile50_pred, percentile75_pred, percentile95_pred), 
                                            c(5, 25, 50, 75, 95), xout = pred_onset)$y
      }
      
      # percent people who can't double crop due to accelerated demise (compared to 2014 observed planting and demise)
      if (pred_latest_plant >= percentile95_pred) {
        percent_affected_early_demise <- 0
      }
      else if (pred_latest_plant <= percentile5_pred) {
        percent_affected_early_demise <- 100
      }
      else {
        # # percent of currently cropped DC who technically shouldn't be able to do DC
        # obs_percent_affected <- approx(c(percentile5_obs, percentile25_obs, percentile50_obs, percentile75_obs, percentile95_obs), 
        #                                     c(5, 25, 50, 75, 95), xout = obs_latest_plant)$y
        # 
        # # percent of currently cropped DC who won't be able to do DC in the future
        # pred_percent_affected <- approx(c(percentile5_pred, percentile25_pred, percentile50_pred, percentile75_pred, percentile95_pred), 
        #                                     c(5, 25, 50, 75, 95), xout = pred_latest_plant)$y
        # 
        # # change in percent of people who won't be able to do DC
        # percent_affected_early_demise <- pred_percent_affected - obs_percent_affected
        
        percent_affected_early_demise <- 100 - approx(c(percentile5_pred, percentile25_pred, percentile50_pred, percentile75_pred, percentile95_pred), 
                                            c(5, 25, 50, 75, 95), xout = pred_latest_plant)$y
      }
      
      predictions_summary <- rbind(predictions_summary, 
                                   data.frame(intensity = intensity,
                                              region = region,
                                              pred_type = pred_type,
                                              change_plant = area,
                                              percent_affect_late_onset = percent_affect_late_onset, 
                                              percent_affected_early_demise = percent_affected_early_demise,
                                              window = window))
      
    }

    # set max x limit based on cropping intensity
    if (intensity == 'SC') {max_xlim <- 230}
    if (intensity == 'DC') {max_xlim <- 130}
    
    predictions_plot <- ggplot(predictions) +
      geom_line(mapping = aes(x = plant, y = percentile, col = type)) +
      geom_point(mapping = aes(x = plant, y = percentile, col = type)) +
      geom_vline(mapping = aes(xintercept = obs_onset), col = 'blue') +
      geom_vline(mapping = aes(xintercept = pred_onset), col = 'blue', linetype = 'dashed') +
      geom_vline(mapping = aes(xintercept = obs_latest_plant), col = 'red') +
      geom_vline(mapping = aes(xintercept = pred_latest_plant), col = 'red', linetype = 'dashed') +
      ggtitle(paste('Planting CDF',intensity, region, 'region', 'case', case_name)) +
      xlim(30, max_xlim) +
      theme_bw()
      
    print(predictions_plot)
  }
}

print(predictions_summary)

```

## heatmap of predicted metrics

```{r}

# sample_predicted <- data.frame(case = c('worst', 'worst', 'medium', 'medium', 'best', 'best',
#                                             'worst', 'worst', 'medium', 'medium', 'best', 'best',
#                                             'worst', 'worst', 'medium', 'medium', 'best', 'best',
#                                             'worst', 'worst', 'medium', 'medium', 'best', 'best'),
#                           intensity = c('SC', 'DC', 'SC', 'DC', 'SC', 'DC',
#                                         'SC', 'DC', 'SC', 'DC', 'SC', 'DC',
#                                         'SC', 'DC', 'SC', 'DC', 'SC', 'DC',
#                                         'SC', 'DC', 'SC', 'DC', 'SC', 'DC'), 
#                           region = c('east', 'east', 'east', 'east', 
#                                      'east', 'east', 'east', 'east',
#                                      'east', 'east', 'east', 'east',
#                                      'west', 'west', 'west', 'west',
#                                      'west', 'west', 'west', 'west',
#                                      'west', 'west', 'west', 'west'),
#                           trend = c('yes', 'yes', 'yes', 'yes', 'yes', 'yes',
#                                     'no', 'no', 'no', 'no', 'no', 'no',
#                                     'yes', 'yes', 'yes', 'yes', 'yes', 'yes',
#                                     'no', 'no', 'no', 'no', 'no', 'no'),
#                           value = c(1,2,3,4,5,6,
#                                     7,8,9,10,11,12,
#                                     13, 14, 15, 16, 17, 18,
#                                     19, 20, 21, 22, 23, 24
#                                     ))
# sample_predicted$yID<- with(sample_predicted, paste0(case, intensity))
# sample_predicted$xID<- with(sample_predicted, paste0(region, trend))
# 
# print(sample_predicted)
# 
# ggplot(data = sample_predicted, mapping = aes(x = xID, y = yID, fill = value)) +
#   geom_tile() +
#   geom_text(aes(fill = sample_predicted$value, label = round(sample_predicted$value, 2))) + # write the values
#   xlab(label = "Sample") +
#   ggtitle("Metric name")

plant_delay_days_predicted <- data.frame(case = c('worst', 'worst', 'medium', 'medium', 'best', 'best',
                                            'worst', 'worst', 'medium', 'medium', 'best', 'best',
                                            'worst', 'worst', 'medium', 'medium', 'best', 'best',
                                            'worst', 'worst', 'medium', 'medium', 'best', 'best'),
                          intensity = c('SC', 'DC', 'SC', 'DC', 'SC', 'DC',
                                        'SC', 'DC', 'SC', 'DC', 'SC', 'DC',
                                        'SC', 'DC', 'SC', 'DC', 'SC', 'DC',
                                        'SC', 'DC', 'SC', 'DC', 'SC', 'DC'), 
                          region = c('east', 'east', 'east', 'east', 
                                     'east', 'east', 'east', 'east',
                                     'east', 'east', 'east', 'east',
                                     'west', 'west', 'west', 'west',
                                     'west', 'west', 'west', 'west',
                                     'west', 'west', 'west', 'west'),
                          trend = c('yes', 'yes', 'yes', 'yes', 'yes', 'yes',
                                    'no', 'no', 'no', 'no', 'no', 'no',
                                    'yes', 'yes', 'yes', 'yes', 'yes', 'yes',
                                    'no', 'no', 'no', 'no', 'no', 'no'),
                          value = c(-14.2, -7.82, -15.94, -11.53, -17.96, -15.85,
                                    2.62, 5.59, 0.87, 1.87, -1.14, -2.44,
                                    -15.11, -9.76, -12.36, -16.33, -17.37, -14.6,
                                    1.71, 3.64, 1.04, 0.49, -0.56, -1.19
                                    ))
plant_delay_days_predicted$yID<- with(plant_delay_days_predicted, paste0(case, intensity))
plant_delay_days_predicted$xID<- with(plant_delay_days_predicted, paste0(region, trend))

plant_delay_percent_predicted <- data.frame(case = c('worst', 'worst', 'medium', 'medium', 'best', 'best',
                                            'worst', 'worst', 'medium', 'medium', 'best', 'best',
                                            'worst', 'worst', 'medium', 'medium', 'best', 'best',
                                            'worst', 'worst', 'medium', 'medium', 'best', 'best'),
                          intensity = c('SC', 'DC', 'SC', 'DC', 'SC', 'DC',
                                        'SC', 'DC', 'SC', 'DC', 'SC', 'DC',
                                        'SC', 'DC', 'SC', 'DC', 'SC', 'DC',
                                        'SC', 'DC', 'SC', 'DC', 'SC', 'DC'), 
                          region = c('east', 'east', 'east', 'east', 
                                     'east', 'east', 'east', 'east',
                                     'east', 'east', 'east', 'east',
                                     'west', 'west', 'west', 'west',
                                     'west', 'west', 'west', 'west',
                                     'west', 'west', 'west', 'west'),
                          trend = c('yes', 'yes', 'yes', 'yes', 'yes', 'yes',
                                    'no', 'no', 'no', 'no', 'no', 'no',
                                    'yes', 'yes', 'yes', 'yes', 'yes', 'yes',
                                    'no', 'no', 'no', 'no', 'no', 'no'),
                          value = c(44.91, 61.35, 18.33, 24.14, 0, 0,
                                    0, 6.77, 0, 0, 0, 0,
                                    44.81, 53.22, 23.02, 24.02, 13.07, 13.64,
                                    0, 0, 0, 0, 0, 0
                                    ))
plant_delay_percent_predicted$yID<- with(plant_delay_percent_predicted, paste0(case, intensity))
plant_delay_percent_predicted$xID<- with(plant_delay_percent_predicted, paste0(region, trend))

DC_not_possible_predicted <- data.frame(case = c('worst', 'medium', 'best',
                                                 'worst', 'medium', 'best',
                                                 'worst', 'medium', 'best',
                                                 'worst', 'medium', 'best'),
                          region = c('east', 'east', 'east', 'east', 'east', 'east', 
                                     'west', 'west', 'west', 'west', 'west', 'west'),
                          trend = c('yes', 'yes', 'yes', 
                                    'no', 'no', 'no', 
                                    'yes', 'yes', 'yes', 
                                    'no', 'no', 'no'),
                          value = c(73.86, 11.98, 0, 100, 42.18, 8.95, 
                                    21.07, 0, 0, 75.26, 9.49, 0))
DC_not_possible_predicted$yID<- with(DC_not_possible_predicted, paste0(case))
DC_not_possible_predicted$xID<- with(DC_not_possible_predicted, paste0(region, trend))

plant_window_predicted <- data.frame(case = c('worst', 'worst', 'medium', 'medium', 'best', 'best',
                                            'worst', 'worst', 'medium', 'medium', 'best', 'best'),
                          intensity = c('SC', 'DC', 'SC', 'DC', 'SC', 'DC',
                                        'SC', 'DC', 'SC', 'DC', 'SC', 'DC'), 
                          region = c('east', 'east', 'east', 'east', 
                                     'east', 'east', 
                                     'west', 'west', 'west', 'west',
                                     'west', 'west'),
                          value = c(101.34, 0, 133.99, 23.99, 161.9, 51.9,
                                    118.5, 8.48, 147.35, 37.35, 169.36, 59.36))
plant_window_predicted$yID<- with(plant_window_predicted, paste0(case, intensity))
plant_window_predicted$xID<- with(plant_window_predicted, paste0(region))

ggplot(data = plant_delay_days_predicted, mapping = aes(x = xID, y = yID, fill = value)) +
  geom_tile() +
  geom_text(aes(label = round(plant_delay_days_predicted$value, 1))) + # write the values
  scale_fill_gradient2(name = "Days", low = "blue", high = "red", midpoint = 0) +
  ggtitle("Average delay in planting date in average 25km cell") +
  theme_bw()

ggplot(data = plant_delay_percent_predicted, mapping = aes(x = xID, y = yID, fill = value)) +
  geom_tile() +
  geom_text(aes(label = round(plant_delay_percent_predicted$value, 1))) + # write the values
  scale_fill_gradient2(name = "Percent", low = "white", high = "red") +
  ggtitle("Percent planting that must be delayed in average 25km cell") +
  theme_bw()

ggplot(data = DC_not_possible_predicted, mapping = aes(x = xID, y = yID, fill = value)) +
  geom_tile() +
  geom_text(aes(label = round(DC_not_possible_predicted$value, 1))) + # write the values
  scale_fill_gradient2(name = "Percent", low = "white", high = "red") +
  ggtitle("Percent double cropping that's infeasible in average 25km cell") +
  theme_bw()

ggplot(data = plant_window_predicted, mapping = aes(x = xID, y = yID, fill = value)) +
  geom_tile() +
  geom_text(aes(label = round(plant_window_predicted$value, 1))) + # write the values
  scale_fill_gradient(name = "Days", low = "red", high = "white") +
  ggtitle("Planting window in average 25km cell") +
  theme_bw()

```

## plot of onset, demise predictions

```{r}

library(tidyr)
nw_predictions <- read.csv(paste0(first_folder,'/R-code2/ModelingPaper/northwest_MT_prediction_csv.csv'))
ne_predictions <- read.csv(paste0(first_folder,'/R-code2/ModelingPaper/northeast_MT_prediction_csv.csv'))

# CHANGE ONSET AND DEMISE from days after July 1 (the input) to days after Aug 1
nw_predictions$outoday <- nw_predictions$outoday - 31
nw_predictions$outeday <- nw_predictions$outeday - 31
ne_predictions$outoday <- ne_predictions$outoday - 31
ne_predictions$outeday <- ne_predictions$outeday - 31

nw_predictions_tidy <- nw_predictions %>% 
  rename(onset = outoday, demise = outeday) %>%
  gather("wet_season_metric", "day", 2:3)

ne_predictions_tidy <- ne_predictions %>% 
  rename(onset = outoday, demise = outeday) %>%
  gather("wet_season_metric", "day", 2:3)

nw_predictions <- nw_predictions %>% 
  rename(onset = outoday, demise = outeday, length = outslen)

ne_predictions <- ne_predictions %>% 
  rename(onset = outoday, demise = outeday, length = outslen)

nw_onset_mean_before <- mean(nw_predictions[nw_predictions$time <= 2000, 'onset'])
nw_onset_mean_after <- mean(nw_predictions[nw_predictions$time >= 2020, 'onset'])
nw_demise_mean_before <- mean(nw_predictions[nw_predictions$time <= 2000, 'demise'])
nw_demise_mean_after <- mean(nw_predictions[nw_predictions$time >= 2020, 'demise'])
nw_length_mean_before <- mean(nw_predictions[nw_predictions$time <= 2000, 'length'])
nw_length_mean_after <- mean(nw_predictions[nw_predictions$time >= 2020, 'length'])

ne_onset_mean_before <- mean(ne_predictions[ne_predictions$time <= 2000, 'onset'])
ne_onset_mean_after <- mean(ne_predictions[ne_predictions$time >= 2020, 'onset'])
ne_demise_mean_before <- mean(ne_predictions[ne_predictions$time <= 2000, 'demise'])
ne_demise_mean_after <- mean(ne_predictions[ne_predictions$time >= 2020, 'demise'])
ne_length_mean_before <- mean(ne_predictions[ne_predictions$time <= 2000, 'length'])
ne_length_mean_after <- mean(ne_predictions[ne_predictions$time >= 2020, 'length'])

# plot onset and demise
ggplot(nw_predictions_tidy) +
  geom_rect(mapping=aes(xmin=2000, xmax=2020, ymin=50, ymax=400), fill="lightgray", alpha=0.1) +
  geom_line(aes(x = time, y = day, color = wet_season_metric)) +
  geom_segment(aes(x = 1970, y = nw_onset_mean_before, xend = 2000, yend = nw_onset_mean_before), 
               col = 'black', size = 1, linetype = 'dashed') +
  geom_segment(aes(x = 1970, y = nw_demise_mean_before, xend = 2000, yend = nw_demise_mean_before), 
               col = 'black', size = 1, linetype = 'dashed') +
  geom_segment(aes(x = 2020, y = nw_onset_mean_after, xend = 2049, yend = nw_onset_mean_after), 
               col = 'black', size = 1, linetype = 'dashed') +
  geom_segment(aes(x = 2020, y = nw_demise_mean_after, xend = 2049, yend = nw_demise_mean_after), 
               col = 'black', size = 1, linetype = 'dashed') +
  ggtitle('Predictions for northwest Mato Grosso') +
  ylab('Days after Aug 1') +
  xlab('Year') +
  geom_text(aes(x = 1985, y = 375, label = "Historical"), color = "black", size = 5) +
  geom_text(aes(x = 2035, y = 375, label = "Predictions"), color = "black", size = 5) +
  theme_bw()

ggplot(ne_predictions_tidy) +
  geom_rect(mapping=aes(xmin=2000, xmax=2020, ymin=50, ymax=400), fill="lightgray", alpha=0.1) +
  geom_line(aes(x = time, y = day, color = wet_season_metric)) +
  geom_segment(aes(x = 1970, y = ne_onset_mean_before, xend = 2000, yend = ne_onset_mean_before), 
               col = 'black', size = 1, linetype = 'dashed') +
  geom_segment(aes(x = 1970, y = ne_demise_mean_before, xend = 2000, yend = ne_demise_mean_before), 
               col = 'black', size = 1, linetype = 'dashed') +
  geom_segment(aes(x = 2020, y = ne_onset_mean_after, xend = 2049, yend = ne_onset_mean_after), 
               col = 'black', size = 1, linetype = 'dashed') +
  geom_segment(aes(x = 2020, y = ne_demise_mean_after, xend = 2049, yend = ne_demise_mean_after), 
               col = 'black', size = 1, linetype = 'dashed') +
  ggtitle('Predictions for northeast Mato Grosso') +
  ylab('Days after Aug 1') +
  xlab('Year') +
  geom_text(aes(x = 1985, y = 375, label = "Historical"), color = "black", size = 5) +
  geom_text(aes(x = 2035, y = 375, label = "Predictions"), color = "black", size = 5) +
  theme_bw()

# plot wet season length
ggplot(nw_predictions) +
  geom_rect(mapping=aes(xmin=2000, xmax=2020, ymin=150, ymax=320), fill="lightgray", alpha=0.1) +
  geom_line(aes(x = time, y = length)) +
  geom_segment(aes(x = 1970, y = nw_length_mean_before, xend = 2000, yend = nw_length_mean_before), 
               col = 'blue', size = 1, linetype = 'dashed') +
  geom_segment(aes(x = 2020, y = nw_length_mean_after, xend = 2049, yend = nw_length_mean_after), 
               col = 'blue', size = 1, linetype = 'dashed') +
  geom_hline(yintercept = 200, color = 'red') +
  ggtitle('Predictions for northwest Mato Grosso') +
  ylab('Wet season length') +
  xlab('Year') +
  geom_text(aes(x = 1985, y = 300, label = "Historical"), color = "black", size = 5) +
  geom_text(aes(x = 2035, y = 300, label = "Predictions"), color = "black", size = 5) +
  theme_bw()

ggplot(ne_predictions) +
  geom_rect(mapping=aes(xmin=2000, xmax=2020, ymin=150, ymax=320), fill="lightgray", alpha=0.1) +
  geom_line(aes(x = time, y = length)) +
  geom_segment(aes(x = 1970, y = ne_length_mean_before, xend = 2000, yend = ne_length_mean_before), 
               col = 'blue', size = 1, linetype = 'dashed') +
  geom_segment(aes(x = 2020, y = ne_length_mean_after, xend = 2049, yend = ne_length_mean_after), 
               col = 'blue', size = 1, linetype = 'dashed') +
  geom_hline(yintercept = 200, color = 'red') +
  ggtitle('Predictions for northeast Mato Grosso') +
  ylab('Wet season length') +
  xlab('Year') +
  geom_text(aes(x = 1985, y = 300, label = "Historical"), color = "black", size = 5) +
  geom_text(aes(x = 2035, y = 300, label = "Predictions"), color = "black", size = 5) +
  theme_bw()
```

# correlation between onset and demise
```{r}

library(fmsb) # calculate percentile

corr_nw <- cor.test(nw_predictions$onset, nw_predictions$demise)
corr_ne <- cor.test(ne_predictions$onset, ne_predictions$demise)
corr_nw_est <- round(corr_nw$estimate, 3)[1]
corr_ne_est <- round(corr_ne$estimate, 3)[1]
corr_nw_pval <- round(corr_nw$p.value, 3)
corr_ne_pval <- round(corr_ne$p.value, 3)

corr_nw_plot <- ggplot(nw_predictions, aes(x = onset, y = demise)) +
  geom_point() +
  geom_smooth(method=lm, se=FALSE) +
  ggtitle('Northwest MT') +
  annotate("text", x = 25, y = 250, color = "red", 
           label = paste0("Pearson correlation: ", corr_nw_est, ", \n p-value: ", corr_nw_pval)) +
  theme_bw()

corr_ne_plot <- ggplot(ne_predictions, aes(x = onset, y = demise)) +
  geom_point() +
  geom_smooth(method=lm, se=FALSE) +
  ggtitle('Northeast MT') +
  annotate("text", x = 30, y = 220, color = "red", 
           label = paste0("Pearson correlation: ", corr_ne_est, ", \n p-value: ", corr_ne_pval)) +
  theme_bw()

print(corr_nw_plot)
print(corr_ne_plot)

# figure out if we want medium or late onset to pair with early, medium demise
# convert onset, demise into percentiles
nw_predictions$onset_percentile <- percentile(nw_predictions$onset)
nw_predictions$demise_percentile <- percentile(nw_predictions$demise)
nw_predictions$length_percentile <- percentile(nw_predictions$length)

ne_predictions$onset_percentile <- percentile(ne_predictions$onset)
ne_predictions$demise_percentile <- percentile(ne_predictions$demise)
ne_predictions$length_percentile <- percentile(ne_predictions$length)

# get 10th, 50th, 90th percentile demise, and for those years, get the onset percentile
nw_lateDemise_onsetPer <- nw_predictions[nw_predictions$demise_percentile >= 85 & 
                                          nw_predictions$demise_percentile <= 95, 
                                       'onset_percentile']

ne_lateDemise_onsetPer <- ne_predictions[ne_predictions$demise_percentile >= 85 & 
                                          ne_predictions$demise_percentile <= 95, 
                                       'onset_percentile']

nw_medDemise_onsetPer <- nw_predictions[nw_predictions$demise_percentile >= 45 & 
                                          nw_predictions$demise_percentile <= 55, 
                                       'onset_percentile']

ne_medDemise_onsetPer <- ne_predictions[ne_predictions$demise_percentile >= 45 & 
                                          ne_predictions$demise_percentile <= 55, 
                                       'onset_percentile']

nw_earlyDemise_onsetPer <- nw_predictions[nw_predictions$demise_percentile >= 5 & 
                                          nw_predictions$demise_percentile <= 15, 
                                       'onset_percentile']

ne_earlyDemise_onsetPer <- ne_predictions[ne_predictions$demise_percentile >= 5 & 
                                          ne_predictions$demise_percentile <= 15, 
                                       'onset_percentile']

nw_onset_demise_pairing <- rbind(data.frame(demise_percentile = 'late', 
                                            onset_percentile = nw_lateDemise_onsetPer),
                                  data.frame(demise_percentile = 'middle', 
                                            onset_percentile = nw_medDemise_onsetPer),
                                 data.frame(demise_percentile = 'early', 
                                            onset_percentile = nw_earlyDemise_onsetPer))
nw_onset_demise_pairing$demise_percentile <- as.factor(nw_onset_demise_pairing$demise_percentile)

ne_onset_demise_pairing <- rbind(data.frame(demise_percentile = 'late', 
                                            onset_percentile = ne_lateDemise_onsetPer),
                                 data.frame(demise_percentile = 'middle', 
                                            onset_percentile = ne_medDemise_onsetPer),
                                 data.frame(demise_percentile = 'early', 
                                            onset_percentile = ne_earlyDemise_onsetPer))
ne_onset_demise_pairing$demise_percentile <- as.factor(ne_onset_demise_pairing$demise_percentile)

nw_onset_demise_boxplot <- ggplot(nw_onset_demise_pairing, aes(x = demise_percentile, y = onset_percentile)) +
  geom_boxplot() +
  geom_hline(yintercept=50, linetype="dashed", color = "blue") +
  xlab('Demise category') +
  ylab('Onset percentile') +
  ggtitle('Northwest MT') +
  theme_bw()

ne_onset_demise_boxplot <- ggplot(ne_onset_demise_pairing, aes(x = demise_percentile, y = onset_percentile)) +
  geom_boxplot() +
  geom_hline(yintercept=50, linetype="dashed", color = "blue") +
  xlab('Demise category') +
  ylab('Onset percentile') +
  ggtitle('Northeast MT') +
  theme_bw()

print(nw_onset_demise_boxplot)
print(ne_onset_demise_boxplot)

```