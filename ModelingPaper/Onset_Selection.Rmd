---
title: "Onset_Selection"
output: html_document
---


```{r}

# import data

library(ggplot2)
library(tidyverse)
library(dplyr)
library(rgdal)
library(raster)
library(sf)
library(sp)
library(leaps)
library(viridis)
library(spatial)
library(spdep)
library(plm)

os_system <- 'windows' # mac for laptop or windows for desktop
if (os_system == 'windows') {first_folder <- 'E:'}
if (os_system == 'mac') {first_folder <- '~/Documents'}
if (os_system == 'windows_laptop') {first_folder <- 'D:'}

#E:/R-code/Modeling/code/FCN_clean_csvs.R
#~/Documents/R-code
source(paste0(first_folder,'/R-code2/Modeling/code/FCN_clean_csvs.R'))
source(paste0(first_folder,'/R-code2/Modeling/code/FCN_plotting.R'))
source(paste0(first_folder,'/R-code2/Modeling/code/FCN_sample_data.R'))
source(paste0(first_folder,'/R-code2/Modeling/code/FCN_run_model_spatial_sampled.R'))


MT_outline <- readOGR(dsn = paste0(first_folder,'/R-code2/Modeling/data/shp/MatoGrossoOutline'), layer = 'MatoGrossoOutline')
crs(MT_outline) <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")

# read in all the onsets. only the csv, not shp
all_onset_types <- c('AA_2_persiann', 'AA_3_persiann', 
                      'AA_25_persiann', 'AA_25_chirps_ATgabriel25km', 'AA_25_persiann_ATgabriel25km',
                     'freq_5_persiann', 'freq_8_persiann', 'freq_10_persiann', 'freq_12_persiann',
                     'monsoon_30_persiann', 'monsoon_40_persiann',
                     'pentad_8_persiann', 'pentad_10_persiann', 'pentad_15_persiann',
                     'rangethres_10_15_15_30_persiann', 'rangethres_10_15_15_40_persiann',
                     'rangethres_10_15_20_20_persiann', 'rangethres_10_15_20_30_persiann',
                     'rangethres_10_15_30_40_persiann', 'thres_10_persiann',
                     'AA_25_chirps_ATchirps5km', 
                     'freq_5_chirps_ATchirps5km', 'freq_8_chirps_ATchirps5km', 
                     'freq_10_chirps_ATchirps5km', 'freq_12_chirps_ATchirps5km',
                     'rangethres_10_15_15_30_chirps_ATchirps5km',
                     'rangethres_10_15_15_40_chirps_ATchirps5km',
                     'rangethres_10_15_20_20_chirps_ATchirps5km',
                     'rangethres_10_15_20_30_chirps_ATchirps5km',
                     'rangethres_10_15_30_40_chirps_ATchirps5km')

# save onset information for specific onsets
onset_info <- data.frame(
  onset_type = character(0),
  grid_size = numeric(0),
  precip_data = character(0),
  onset_def_type = character(0),
  thres = character(0),
  onset_scale = character(0)
)

onset_info <- rbind(onset_info,
                    data.frame(onset_type = 'Gabriel_onset', grid_size = 0.75, precip_data = 'Xavier', onset_def_type = 'AA', thres = '2.5', onset_scale = '25km_Gabriel'),
                    data.frame(onset_type = 'AA_2_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'AA', thres = '2', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'AA_3_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'AA', thres = '3', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'AA_25_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'AA', thres = '2.5', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'AA_25_chirps_ATgabriel25km', grid_size = 0.75, precip_data = 'chirps', onset_def_type = 'AA', thres = '2.5', onset_scale = '25km_Gabriel'),
                    data.frame(onset_type = 'AA_25_persiann_ATgabriel25km', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'AA', thres = '2.5', onset_scale = '25km_Gabriel'),
                    data.frame(onset_type = 'freq_5_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'freq', thres = '5', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'freq_8_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'freq', thres = '8', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'freq_10_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'freq', thres = '10', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'freq_12_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'freq', thres = '12', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'monsoon_30_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'monsoon', thres = '30', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'monsoon_40_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'monsoon', thres = '40', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'pentad_8_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'pentad', thres = '8', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'pentad_10_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'pentad', thres = '10', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'pentad_15_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'pentad', thres = '15', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'rangethres_10_15_15_30_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'rangethres', thres = '10_15_15_30', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'rangethres_10_15_15_40_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'rangethres', thres = '10_15_15_40', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'rangethres_10_15_20_20_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'rangethres', thres = '10_15_20_20', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'rangethres_10_15_20_30_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'rangethres', thres = '10_15_20_30', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'rangethres_10_15_30_40_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'rangethres', thres = '10_15_30_40', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'thres_10_persiann', grid_size = 0.75, precip_data = 'persiann', onset_def_type = 'thres', thres = '10', onset_scale = '25km_persiann'),
                    data.frame(onset_type = 'AA_25_chirps_ATchirps5km', grid_size = 0.5, precip_data = 'chirps', onset_def_type = 'AA', thres = '2.5', onset_scale = '5km_chirps'),
                    data.frame(onset_type = 'freq_5_chirps_ATchirps5km', grid_size = 0.5, precip_data = 'chirps', onset_def_type = 'freq', thres = '5', onset_scale = '5km_chirps'),
                    data.frame(onset_type = 'freq_8_chirps_ATchirps5km', grid_size = 0.5, precip_data = 'chirps', onset_def_type = 'freq', thres = '8', onset_scale = '5km_chirps'),
                    data.frame(onset_type = 'freq_10_chirps_ATchirps5km', grid_size = 0.5, precip_data = 'chirps', onset_def_type = 'freq', thres = '10', onset_scale = '5km_chirps'),
                    data.frame(onset_type = 'freq_12_chirps_ATchirps5km', grid_size = 0.5, precip_data = 'chirps', onset_def_type = 'freq', thres = '12', onset_scale = '5km_chirps'),
                    data.frame(onset_type = 'rangethres_10_15_15_30_chirps_ATchirps5km', grid_size = 0.5, precip_data = 'chirps', onset_def_type = 'rangethres', thres = '10_15_15_30', onset_scale = '5km_chirps'),
                    data.frame(onset_type = 'rangethres_10_15_15_40_chirps_ATchirps5km', grid_size = 0.5, precip_data = 'chirps', onset_def_type = 'rangethres', thres = '10_15_15_40', onset_scale = '5km_chirps'),
                    data.frame(onset_type = 'rangethres_10_15_20_20_chirps_ATchirps5km', grid_size = 0.5, precip_data = 'chirps', onset_def_type = 'rangethres', thres = '10_15_20_20', onset_scale = '5km_chirps'),
                    data.frame(onset_type = 'rangethres_10_15_20_30_chirps_ATchirps5km', grid_size = 0.5, precip_data = 'chirps', onset_def_type = 'rangethres', thres = '10_15_20_30', onset_scale = '5km_chirps'),
                    data.frame(onset_type = 'rangethres_10_15_30_40_chirps_ATchirps5km', grid_size = 0.5, precip_data = 'chirps', onset_def_type = 'rangethres', thres = '10_15_30_40', onset_scale = '5km_chirps')
                    )

crop_intensities <- c('SC', 'DC')
plant_stat_types <- c('median', 'percentile5', 'percentile25', 'percentile75', 'percentile95')

```

RUN ONLY ONCE:
Run FE model and save results

```{r}
for (onset_type in all_onset_types) {
  
  # get info for the onset_type
  row <- onset_info[onset_info$onset_type == onset_type,]
  
  precip_data <- row$precip_data
  onset_def_type <- row$onset_def_type
  thres <- row$thres
  onset_scale <- row$onset_scale
  
  # read and clean the data ---------------------------------------------------------------------------------------------------------
  filename_median <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_type, '/median_onset_cell_', onset_type, '.csv')
  filename_percentile5 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_type, '/percentile5_onset_cell_', onset_type, '.csv')
  filename_percentile25 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_type, '/percentile25_onset_cell_', onset_type, '.csv')
  filename_percentile75 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_type, 
                                  '/percentile75_onset_cell_', onset_type, '.csv')
  filename_percentile95 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_type, 
                                  '/percentile95_onset_cell_', onset_type, '.csv')

  filename_shp<- paste0(first_folder,'/R-code-large-files/data_onset_', onset_type, '/shp')
  layername_shp <- paste0('median_onset_cell_SHP_', onset_type)
    
  median_cell_raw <- read.csv(filename_median)
  percentile5_cell_raw <- read.csv(filename_percentile5)
  percentile25_cell_raw <- read.csv(filename_percentile25)
  percentile75_cell_raw <- read.csv(filename_percentile75)
  percentile95_cell_raw <- read.csv(filename_percentile95)

  cell_sf <- st_read(dsn = filename_shp, layer = layername_shp)
 
  # CSV DATA -----------------------------------------------------------------------------------------------
  # median cell
  median_cell <- median_cell_raw %>% delete_cols_median_cell() %>%
                                      rename_cols_median_cell()
  median_cell$plant_stat_type <- rep('median', nrow(median_cell))
  
  
  # percentiles
  percentile5_cell <- percentile5_cell_raw %>% rename_cols_percentile_cell()
  percentile25_cell <- percentile25_cell_raw %>% rename_cols_percentile_cell()
  percentile75_cell <- percentile75_cell_raw %>% rename_cols_percentile_cell()
  percentile95_cell <- percentile95_cell_raw %>% rename_cols_percentile_cell()

  # SF DATA ------------------------------------------------------------------------------------------------
  
  # get cell_ID column for median
  cell_sf$cell_ID <- median_cell$cell_ID
  cell_sf$cell_ID <- sapply(as.character(cell_sf$cell_ID), clean_cell_ID)
  
  # join median, percentile data to cell_sf
  # cell_sf has median information, but copy it and put in percentile info for DC and SC plant
  
  cell_sf$plant_stat_type <- rep("median", nrow(cell_sf))
  
  cell_sf_percentile5 <- cell_sf
  cell_sf_percentile5$SC_plant <- percentile5_cell$SC_plant
  cell_sf_percentile5$DC_plant <- percentile5_cell$DC_plant
  cell_sf_percentile5$plant_stat_type <- rep("percentile5", nrow(cell_sf_percentile5))
  
  cell_sf_percentile25 <- cell_sf
  cell_sf_percentile25$SC_plant <- percentile25_cell$SC_plant
  cell_sf_percentile25$DC_plant <- percentile25_cell$DC_plant
  cell_sf_percentile25$plant_stat_type <- rep("percentile25", nrow(cell_sf_percentile25))
  
  cell_sf_percentile75 <- cell_sf
  cell_sf_percentile75$SC_plant <- percentile75_cell$SC_plant
  cell_sf_percentile75$DC_plant <- percentile75_cell$DC_plant
  cell_sf_percentile75$plant_stat_type <- rep("percentile75", nrow(cell_sf_percentile75))
  
  cell_sf_percentile95 <- cell_sf
  cell_sf_percentile95$SC_plant <- percentile95_cell$SC_plant
  cell_sf_percentile95$DC_plant <- percentile95_cell$DC_plant
  cell_sf_percentile95$plant_stat_type <- rep("percentile95", nrow(cell_sf_percentile95))

  cell_sf <- rbind(cell_sf, cell_sf_percentile5, cell_sf_percentile25, cell_sf_percentile75, cell_sf_percentile95)
  
  cell_sf_tidy <- cell_sf %>% tidy_by_intensity_plant("SC_plant", "DC_plant") %>%
              dplyr::select(-c(SC_harvest, DC_harvest)) %>%
              categorize_regions_cell_sf_tidy() # categorize cells into four regions
  
  cell_sf_tidy$year_index <- cell_sf_tidy$year - 2003
  cell_sf_tidy$year_factor <- as.factor(cell_sf_tidy$year)
  
  cell_sf_tidy <- cell_sf_tidy %>%  drop_na
  cell_sf_tidy$delay <- cell_sf_tidy$plant - cell_sf_tidy$onset
  
  # split into SC and DC cells
  cell_sf_tidy_SC <- cell_sf_tidy[cell_sf_tidy$intensity == "SC",]
  cell_sf_tidy_DC <- cell_sf_tidy[cell_sf_tidy$intensity == "DC",]

  # define dataframe to store results --------------------------------------------------------------------------------------
  
  output_results <- data.frame(
  
    model_type <- character(0), # FE or OLS
    intensity = character(0),
    plant_stat_type = character(0),
    lat_predictor = character(0), # to indicate the presence of predictors. yes or no. NA if using fixed effects
    lon_predictor = character(0),
    year_predictor = character(0),
    region_predictor = character(0),
    
    onset_type = character(0),
    precip_data = character(0),
    onset_def_type = character(0),
    thres = character(0),
    onset_scale = character(0),
    
    onset_coef = numeric(0),
    onset_coef_stderr = numeric(0),
    year_coef = numeric(0),
    year_coef_stderr = numeric(0),
    lat_coef = numeric(0),
    lat_coef_stderr = numeric(0),
    
    R2 = numeric(0),
    slope_onset_residual = numeric(0),
    slope_fittedPlant_residual = numeric(0),
    
    moran_i_residual = numeric(0),
    moran_i_pval_residual = numeric(0),
    moran_i_onset = numeric(0),
    moran_i_pval_onset = numeric(0),
    moran_i_plant = numeric(0),
    moran_i_pval_plant = numeric(0)
  )
  
  # FE model ----------------------------------------------------------------------------------------------------------------
  for (plant_stat_type in plant_stat_types) {
    for (crop_intensity in crop_intensities) {
    
        if (crop_intensity == 'SC') {cell_sf_tidy_intensity <- cell_sf_tidy_SC}
        if (crop_intensity == 'DC') {cell_sf_tidy_intensity <- cell_sf_tidy_DC}
        
        # sample from full data and turn into data frame
        sampled_withGeom <- cell_sf_tidy_intensity[cell_sf_tidy_intensity$plant_stat_type == plant_stat_type,]
        sampled <- cell_sf_tidy_intensity[cell_sf_tidy_intensity$plant_stat_type == plant_stat_type,]
        st_geometry(sampled) <- NULL
        
        # for plm, first set data as panel data
        panel <- pdata.frame(sampled,index = c("cell_ID"))
          
        # FE model
        fe_result <- plm(plant ~ onset + year_index, data = panel, model = "within")
          
        # save coefficients
        onset_coef <- summary(fe_result)$coefficients['onset',]['Estimate']
        onset_coef_stderr <- summary(fe_result)$coefficients['onset',]['Std. Error']
        year_coef <- summary(fe_result)$coefficients['year_index',]['Estimate']
        year_coef_stderr <- summary(fe_result)$coefficients['onset',]['Std. Error']
          
        # R2
        SST <- sum((sampled$plant - mean(sampled$plant))^2)
        SSE <- sum((fe_result$residuals - mean(fe_result$residuals))^2)
        R2 <- 1 - SSE/SST
          
        # model diagnostics: residual, observed plant and fitted plant
        error_df <- data.frame(residual = fe_result$residuals,
                                observed = sampled$plant,
                                fitted =  sampled$plant - fe_result$residuals,
                                onset = sampled$onset)
          
          
        onset_residual_model <- lm(residual ~ onset, data = error_df)
        onset_residual_slope <- onset_residual_model$coefficients['onset']
          
        fitted_residual_model <- lm(residual ~ fitted, data = error_df)
        fitted_residual_slope <- fitted_residual_model$coefficients['fitted']
          
        # model diagnostics: spatial autocorrelation of residuals, onset, plant for all years
        sampled_withGeom$residuals <- fe_result$residuals
        
        moran_i_residual_list <- numeric(0)
        moran_i_plant_list <- numeric(0)
        moran_i_onset_list <- numeric(0)
        
        moran_pval_residual_list <- numeric(0)
        moran_pval_plant_list <- numeric(0)
        moran_pval_onset_list <- numeric(0)
        
        for (year_oi in 2004:2014) {
          
          to_autocorrelation <- sampled_withGeom[sampled_withGeom$year == year_oi, ]
          to_autocorrelation_sp <- as(to_autocorrelation, "Spatial")
          st_geometry(to_autocorrelation) <- NULL # turn to_autocorrelation into data frame
          centroids <- coordinates(to_autocorrelation_sp)
          to_autocorrelation_points <- SpatialPointsDataFrame(coords = centroids, data = to_autocorrelation)
          nb<-knn2nb(knearneigh(to_autocorrelation_points)) 
          lw <- nb2listw(nb, zero.policy = TRUE)
            
          # calculate spatial autocorrelation
          moran_residual <- moran.mc(to_autocorrelation_points$residuals, lw, 500, zero.policy = TRUE)
          moran_onset <- moran.mc(to_autocorrelation_points$onset, lw, 500, zero.policy = TRUE)
          moran_plant <- moran.mc(to_autocorrelation_points$plant, lw, 500, zero.policy = TRUE)
            
          moran_i_residual <- moran_residual$statistic
          moran_i_pval_residual <- moran_residual$p.value
          moran_i_onset <- moran_onset$statistic
          moran_i_pval_onset <- moran_onset$p.value
          moran_i_plant <- moran_plant$statistic
          moran_i_pval_plant <- moran_plant$p.value
          
          moran_i_residual_list <- c(moran_i_residual_list, moran_i_residual)
          moran_i_plant_list <- c(moran_i_plant_list, moran_i_plant)
          moran_i_onset_list <- c(moran_i_onset_list, moran_i_onset)
          
          moran_pval_residual_list <- c(moran_pval_residual_list, moran_i_pval_residual)
          moran_pval_plant_list <- c(moran_pval_plant_list, moran_i_pval_plant)
          moran_pval_onset_list <- c(moran_pval_onset_list, moran_i_pval_onset)
        }
          
        # save
        output_row <- data.frame(
            
          model_type = 'FE',
          intensity = crop_intensity, plant_stat_type = plant_stat_type,
           
          lat_predictor = 'NA', lon_predictor = 'NA',
          year_predictor = 'yes', region_predictor = 'NA',
    
          onset_type = onset_type, precip_data = precip_data, onset_def_type = onset_def_type, 
          thres = thres, onset_scale = onset_scale,
            
          onset_coef = onset_coef, onset_coef_stderr = onset_coef_stderr,
          year_coef = year_coef, year_coef_stderr = year_coef_stderr,
          lat_coef = NA, lat_coef_stderr = NA,
            
          R2 = R2, 
          slope_onset_residual = onset_residual_slope, slope_fittedPlant_residual = fitted_residual_slope,
            
          moran_i_residual = mean(moran_i_residual_list), moran_i_pval_residual = mean(moran_pval_residual_list),
          moran_i_onset = mean(moran_i_onset_list), moran_i_pval_onset = mean(moran_pval_onset_list),
          moran_i_plant = mean(moran_i_plant_list), moran_i_pval_plant = mean(moran_pval_plant_list)
        )
          
        #print(output_row)
          
        output_results <- rbind(output_results, output_row)

        }
      }
  
  print(paste('FE done for', onset_type))
  
  # export test results
  filename = paste0('E:/R-code2/Modeling/output/robustness_test_nospatialsample/', onset_type, '.RData')
  save(output_results, file = filename)
}

```

Load FE model results (from FE, using all data, i.e. no spatial sampling)


```{r}

# empty data frame to store results
all_results <- data.frame()

# add in results for each onset_type
for (onset_type in all_onset_types) {

  # read the data ---------------------------------------------------------------------------------------------------------
  filename <- paste0(first_folder,"/R-code2/Modeling/output/robustness_test_nospatialsample/", onset_type, ".RData")
  loaded_data <- load(filename)
  
  #result_name <- paste0(onset_type, '_results')
  #assign(result_name, get(loaded_data))

  all_results <- rbind(all_results, get(loaded_data))
  
  rm(loaded_data) # Remove the old object since you've stored it in result_name

}

# create new column for onset_def_type + thres combination
create_type_and_thres_col <- function(row) {

    onset_type <- row['onset_def_type']
    thres_val <- row['thres']
    type_and_thres <- paste0(onset_type, '_', thres_val)
    return(type_and_thres)
}
 

all_results['onset_def_type_thres'] <- apply(all_results, 1, create_type_and_thres_col)

```

Compare onset and year coefficients between onset definitions

```{r}
onset_coef_DC_AA = all_results[all_results$model_type == 'FE' & all_results$intensity == 'DC' & all_results$onset_type == 'AA_25_persiann', 'onset_coef']
onset_coef_DC_freq = all_results[all_results$model_type == 'FE' & all_results$intensity == 'DC' & all_results$onset_type == 'freq_10_persiann', 'onset_coef']

onset_coef_SC_AA = all_results[all_results$model_type == 'FE' & all_results$intensity == 'SC' & all_results$onset_type == 'AA_25_persiann', 'onset_coef']
onset_coef_SC_freq = all_results[all_results$model_type == 'FE' & all_results$intensity == 'SC' & all_results$onset_type == 'freq_10_persiann', 'onset_coef']

year_coef_DC_AA = all_results[all_results$model_type == 'FE' & all_results$intensity == 'DC' & all_results$onset_type == 'AA_25_persiann', 'year_coef']
year_coef_DC_freq = all_results[all_results$model_type == 'FE' & all_results$intensity == 'DC' & all_results$onset_type == 'freq_10_persiann', 'year_coef']

year_coef_SC_AA = all_results[all_results$model_type == 'FE' & all_results$intensity == 'SC' & all_results$onset_type == 'AA_25_persiann', 'year_coef']
year_coef_SC_freq = all_results[all_results$model_type == 'FE' & all_results$intensity == 'SC' & all_results$onset_type == 'freq_10_persiann', 'year_coef']

print('freq - AA, onset, DC')
print((onset_coef_DC_freq - onset_coef_DC_AA)/onset_coef_DC_freq)

print('freq - AA, onset, SC')
print((onset_coef_SC_freq - onset_coef_SC_AA)/onset_coef_SC_freq)

print('freq - AA, year, DC')
print((year_coef_DC_freq - year_coef_DC_AA)/year_coef_DC_freq)

print('freq - AA, year, SC')
print((year_coef_SC_freq - year_coef_SC_AA)/year_coef_SC_freq)
```

Perform chosen FE model specification for each onset definition

```{r}

# save top five model specs in each intensity x plant_stat_type
top_onsets <- data.frame()
top_onsets_subset <- data.frame()

# best definition for 25th percentile SC and DC. for plotting
best_onset_defs_DC_percentile25 <- c('AA_2.5', 'freq_10', 'monsoon_30', 'pentad_10', 'rangethres_10_15_20_30', 'thres_10')
best_onset_defs_SC_percentile25 <- c('AA_2.5', 'freq_8', 'monsoon_30', 'pentad_10', 'rangethres_10_15_15_40', 'thres_10')

# tabulate onset coef for different intensities, precip datasets, percentiles
for (crop_intensity in c("SC", "DC")) {
    for (plant_stat_type in c("percentile95", "percentile75", "median", "percentile25", "percentile5")) {
      
      # get rid of 25km_Gabriel scale for simplicity
      results <- all_results[all_results$intensity == crop_intensity & all_results$plant_stat_type == plant_stat_type & all_results$onset_scale != '25km_Gabriel',]
      results <- results[order(results$onset_coef),]
      
      results <- transform(results, onset_type=reorder(onset_type, -onset_coef) ) 
      
      # get the top three results for plotting
      results_ordered <- results[dim(results)[1]:1,] # so best onset definition is the top row
      best_onset_coefs <- results_ordered[1:3,'onset_coef']
      best_onset_def_type_thres <- results_ordered[1:3, 'onset_def_type_thres']
      
      # save top five onsets
      top_onsets <- rbind(top_onsets, data.frame(
                                                  crop_intensity = rep(crop_intensity, 5),
                                                  plant_stat_type = rep(plant_stat_type, 5),
                                                  onset_type = results$onset_type[(nrow(results)-4):nrow(results)]))
      
      # for summary plot, get the top onset for each onset definition type
      if (crop_intensity == "SC") {
        results_best_subset <- results[results$onset_def_type_thres %in% best_onset_defs_SC_percentile25,]
        
        # get the top result for plotting
        results_subset_ordered <- results_best_subset[dim(results_best_subset)[1]:1,] # so best onset definition is the top row
        best_onset_coefs_subset <- results_subset_ordered[1:3,'onset_coef']
        best_onset_def_type_thres_subset <- results_subset_ordered[1:3, 'onset_def_type_thres']
      
        # save top five onsets
        top_onsets_subset <- rbind(top_onsets_subset, data.frame(
                                                  crop_intensity = rep(crop_intensity, 5),
                                                  plant_stat_type = rep(plant_stat_type, 5),
                                                  onset_type = results_best_subset$onset_type[(nrow(results)-4):nrow(results)]))
        }
      if (crop_intensity == "DC") {
        results_best_subset <- results[results$onset_def_type_thres %in% best_onset_defs_DC_percentile25,]
        
        # get the top result for plotting
        results_subset_ordered <- results_best_subset[dim(results_best_subset)[1]:1,] # so best onset definition is the top row
        best_onset_coefs_subset <- results_subset_ordered[1:3,'onset_coef']
        best_onset_def_type_thres_subset <- results_subset_ordered[1:3, 'onset_def_type_thres']
      
        # save top five onsets
        top_onsets_subset <- rbind(top_onsets_subset, data.frame(
                                                  crop_intensity = rep(crop_intensity, 5),
                                                  plant_stat_type = rep(plant_stat_type, 5),
                                                  onset_type = results_best_subset$onset_type[(nrow(results)-4):nrow(results)]))
        }
      
      # y axis limits: 5th percentile (0.1 to 0.5); 25th percentile (0.1 to 0.4); 50th percentile (0 to 0.4); 75th percentile (0 to 0.4); 95th percentile (0 to 0.3)
      best_onset_plot <- ggplot(results) +
        geom_point(aes(x = onset_type, y = onset_coef)) +
        geom_errorbar(aes(ymin=onset_coef-onset_coef_stderr, ymax=onset_coef+onset_coef_stderr, x = onset_type)) +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90)) +
        ggtitle(paste(crop_intensity, ",", plant_stat_type)) +
        ylim(c(0, 0.6)) +
        ylab('onset coefficient')
      
      my_colors <- c('25km_persiann' = '#80CDC1', '5km_chirps' = '#A6611A')
      best_onset_plot_scaleCompare <- ggplot(mapping = aes(x = onset_def_type_thres, y = onset_coef, col = onset_scale), results) +
        geom_point() +
        geom_errorbar(aes(ymin=onset_coef-onset_coef_stderr, ymax=onset_coef+onset_coef_stderr)) +
        geom_point(mapping = aes(x=best_onset_def_type_thres[1], y=best_onset_coefs[1]), colour="black", shape = 1, size = 7) +
        geom_point(mapping = aes(x=best_onset_def_type_thres[2], y=best_onset_coefs[2]), colour="black", shape = 1, size = 7) +
        geom_point(mapping = aes(x=best_onset_def_type_thres[3], y=best_onset_coefs[3]), colour="black", shape = 1, size = 7) +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90),
              axis.text.y = element_text(size = 15)) +
        ggtitle(paste(crop_intensity, ",", plant_stat_type)) +
        ylim(c(0, 0.6)) +
        ylab('onset coefficient')
      
      best_onset_plot_scaleCompare_subset <- ggplot(mapping = aes(x = onset_def_type_thres, y = onset_coef, col = onset_scale), results_best_subset) +
        geom_point() +
        geom_errorbar(aes(ymin=onset_coef-onset_coef_stderr, ymax=onset_coef+onset_coef_stderr)) +
        geom_point(mapping = aes(x=best_onset_def_type_thres_subset[1], y=best_onset_coefs_subset[1]), colour="black", shape = 1, size = 7) +
        theme_bw() +
        scale_color_manual(values = my_colors) +
        theme(axis.text.x = element_text(angle = 90),
              axis.text.y = element_text(size = 15)) +
        ggtitle(paste(crop_intensity, ",", plant_stat_type)) +
        ylim(c(0.1, 0.4)) +
        ylab('onset coefficient')
            
      R2_plot <- ggplot(results) +
        geom_point(aes(x = onset_type, y = R2), color = "blue") +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90)) +
        ggtitle(paste(crop_intensity, ",", plant_stat_type)) +
        ylim(c(0, 0.7)) +
        ylab('R2')
      
      moran_i_pval_residual_plot <- ggplot(results) +
        geom_point(aes(x = onset_type, y = moran_i_pval_residual), color = "black") +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90)) +
        ggtitle(paste(crop_intensity, ",", plant_stat_type)) +
        ylim(c(-0.2, 1.2)) +
        geom_hline(yintercept = 0.05, color = 'red') +
        ylab('p-val of morans I for residual')
      
      moran_i_pval_residual_plot_scaleCompare <- ggplot(results) +
        geom_point(aes(x = onset_def_type_thres, y = moran_i_pval_residual, col = onset_scale)) +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90)) +
        ggtitle(paste(crop_intensity, ",", plant_stat_type)) +
        ylim(c(-0.2, 1.2)) +
        geom_hline(yintercept = 0.05, color = 'red') +
        ylab('p-val of morans I for residual')
      
      results_persiann <- results[results$precip_data == 'persiann',]
      
      best_onset_plot_persiann <- ggplot(mapping = aes(x = onset_def_type_thres, y = onset_coef, col = onset_scale), results_persiann) +
        geom_point() +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 90)) +
        ggtitle(paste(crop_intensity, ",", plant_stat_type)) +
        ylim(c(0.1, 0.5)) +
        ylab('onset coefficient')
      
      #print(best_onset_plot)
      #print(best_onset_plot_scaleCompare)
      print(best_onset_plot_scaleCompare_subset)
      #print(best_onset_plot_persiann)
      #print(R2_plot)
      #print(moran_i_pval_residual_plot_scaleCompare)
    }
}
```

Freq_10_persiann is best for all DC, and SC-percentile5. Freq_8_chirps is best for SC percentile25 and median, though freq_10_persiann is alright for SC percentile25.


Find the best onset definition within each onset_def_type_thres, across precip data sources, intensities and percentiles
```{r}

grouped_results <- all_results %>% 
  filter(plant_stat_type %in% c('percentile25', 'median', 'percentile75')) %>% 
           group_by(onset_def_type_thres, precip_data) %>%
  summarize(mean_onset_coef = mean(onset_coef))

grouped_results <- grouped_results[order(-grouped_results$mean_onset_coef),]

print(grouped_results)
```

The above suggests that SC, median does a lot better under chirps than persiann, while SC, percentile25 doesn't care much about the precip/scale, and the rest perform better under persiann than chirps. To see if this difference is due to the effect of scale (5 vs 25km) or the effect of data source, did analysis for AA_25 under all three possible precip x scale combinations.

```{r}

results_AA_25 <- all_results[all_results$onset_def_type == 'AA' & all_results$thres == '2.5' & all_results$onset_scale != '25km_persiann',]

# turn median into percentile50
results_AA_25$plant_stat_type <- as.character(results_AA_25$plant_stat_type)
results_AA_25[results_AA_25$plant_stat_type=="median", 'plant_stat_type']<-'percentile50'
results_AA_25$plant_stat_type <- factor(results_AA_25$plant_stat_type, 
                                        levels = c('percentile5', 'percentile25', 'percentile50', 'percentile75', 'percentile95'))


my_colors <- c('AA_25_chirps_ATgabriel25km' = '#018571', 'AA_25_persiann_ATgabriel25km' = '#80CDC1', 
               'AA_25_chirps_ATchirps5km' = '#A6611A')

full_plot <- ggplot(results_AA_25, aes(x = plant_stat_type, y = onset_coef)) + #, col = onset_type)) +
  geom_point(alpha = 1, aes(col = onset_type), size = 1.5) + 
  facet_wrap(~ intensity) +
  scale_color_manual(values = my_colors) +
  theme_bw() +
  coord_fixed(ratio = 10) +
  theme(axis.text.x = element_text(angle = 90)) 
# group the x axis by precip type, scale

SC_plot <- ggplot(results_AA_25[results_AA_25$intensity == 'SC',], aes(x = plant_stat_type, y = onset_coef)) + #, col = onset_type)) +
  geom_point(alpha = 1, aes(col = onset_type), size = 3) + 
  scale_color_manual(values = my_colors) +
  theme_bw() +
  ggtitle('SC') +
  ylim(c(0, 0.4)) +
  theme(axis.text.x = element_text(angle = 90),
        axis.text.y = element_text(size = 15))

DC_plot <- ggplot(results_AA_25[results_AA_25$intensity == 'DC',], aes(x = plant_stat_type, y = onset_coef)) + #, col = onset_type)) +
  geom_point(alpha = 1, aes(col = onset_type), size = 3) + 
  scale_color_manual(values = my_colors) +
  theme_bw() +
  ylim(c(0, 0.4)) +
  ggtitle('DC') +
  theme(axis.text.x = element_text(angle = 90),
        axis.text.y = element_text(size = 15)) 

print(full_plot)
print(SC_plot)
print(DC_plot)
```

The difference between chirps and persiann is mainly due to scale difference. When chirps and persiann are aggregated to the same grid, their onset coefficient is very similar. The difference between chirps at 5km and chirps at 25km is much larger, meaning that the scale makes a bigger difference than the precipitation data source. 


READ AN INDIVIDUAL ONSET FOR MAPPING

```{r}

# import data for onset_oi
onset_oi <- 'AA_25_persiann' #'freq_8_chirps_ATchirps5km' #'freq_10_persiann' # 'rangethres_10_15_20_30_persiann'
onset_baseline <- 'AA_25_persiann' # to compare to onset_oi in difference maps, etc 'AA_25_persiann'
onset_third <- 'rangethres_10_15_20_30_persiann' # just to plot the timeseries

# FOR onset_oi ------------------------------------------------------------------------------------------------------------------------
# read and clean the data ---------------------------------------------------------------------------------------------------------
filename_median <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi, '/median_onset_cell_', onset_oi , '.csv')
filename_percentile5 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi , '/percentile5_onset_cell_', onset_oi , '.csv')
filename_percentile25 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi , '/percentile25_onset_cell_', onset_oi , '.csv')
filename_percentile75 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi, 
                                  '/percentile75_onset_cell_', onset_oi, '.csv')
filename_percentile95 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi, 
                                  '/percentile95_onset_cell_', onset_oi, '.csv')

filename_shp<- paste0(first_folder,'/R-code-large-files/data_onset_', onset_oi , '/shp')
layername_shp <- paste0('median_onset_cell_SHP_', onset_oi )
    
median_cell_raw <- read.csv(filename_median)
percentile5_cell_raw <- read.csv(filename_percentile5)
percentile25_cell_raw <- read.csv(filename_percentile25)
percentile75_cell_raw <- read.csv(filename_percentile75)
percentile95_cell_raw <- read.csv(filename_percentile95)

cell_sf <- st_read(dsn = filename_shp, layer = layername_shp)
 
# CSV DATA -----------------------------------------------------------------------------------------------
# median cell
median_cell <- median_cell_raw %>% delete_cols_median_cell() %>%
                                      rename_cols_median_cell()
median_cell$plant_stat_type <- rep('median', nrow(median_cell))
  
# percentiles
percentile5_cell <- percentile5_cell_raw %>% rename_cols_percentile_cell()
percentile25_cell <- percentile25_cell_raw %>% rename_cols_percentile_cell()
percentile75_cell <- percentile75_cell_raw %>% rename_cols_percentile_cell()
percentile95_cell <- percentile95_cell_raw %>% rename_cols_percentile_cell()
  
# SF DATA ------------------------------------------------------------------------------------------------
  
# get cell_ID column for median
cell_sf$cell_ID <- median_cell$cell_ID
cell_sf$cell_ID <- sapply(as.character(cell_sf$cell_ID), clean_cell_ID)
  
# join median, percentile data to cell_sf
# cell_sf has median information, but copy it and put in percentile info for DC and SC plant
  
cell_sf$plant_stat_type <- rep("median", nrow(cell_sf))
  
cell_sf_percentile5 <- cell_sf
cell_sf_percentile5$SC_plant <- percentile5_cell$SC_plant
cell_sf_percentile5$DC_plant <- percentile5_cell$DC_plant
cell_sf_percentile5$plant_stat_type <- rep("percentile5", nrow(cell_sf_percentile5))
  
cell_sf_percentile25 <- cell_sf
cell_sf_percentile25$SC_plant <- percentile25_cell$SC_plant
cell_sf_percentile25$DC_plant <- percentile25_cell$DC_plant
cell_sf_percentile25$plant_stat_type <- rep("percentile25", nrow(cell_sf_percentile25))

cell_sf_percentile75 <- cell_sf
cell_sf_percentile75$SC_plant <- percentile75_cell$SC_plant
cell_sf_percentile75$DC_plant <- percentile75_cell$DC_plant
cell_sf_percentile75$plant_stat_type <- rep("percentile75", nrow(cell_sf_percentile75))

cell_sf_percentile95 <- cell_sf
cell_sf_percentile95$SC_plant <- percentile95_cell$SC_plant
cell_sf_percentile95$DC_plant <- percentile95_cell$DC_plant
cell_sf_percentile95$plant_stat_type <- rep("percentile95", nrow(cell_sf_percentile95))

cell_sf <- rbind(cell_sf, cell_sf_percentile5, cell_sf_percentile25, cell_sf_percentile75, cell_sf_percentile95)
  
cell_sf_tidy <- cell_sf %>% tidy_by_intensity_plant("SC_plant", "DC_plant") %>%
            dplyr::select(-c(SC_harvest, DC_harvest)) %>%
            categorize_regions_cell_sf_tidy() # categorize cells into four regions
  
cell_sf_tidy$year_index <- cell_sf_tidy$year - 2003
cell_sf_tidy$year_factor <- as.factor(cell_sf_tidy$year)
  
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy$delay <- cell_sf_tidy$plant - cell_sf_tidy$onset
  
# calculate quantiles of onset
onset_oi_data <- cell_sf_tidy %>% 
                    mutate(onset_quantile_allyears = ntile(onset, 10))

print('onset_oi done')

# FOR onset_baseline ------------------------------------------------------------------------------------------------------------------
# read and clean the data ---------------------------------------------------------------------------------------------------------
filename_median <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_baseline, '/median_onset_cell_', onset_baseline , '.csv')
filename_percentile5 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_baseline , '/percentile5_onset_cell_', onset_baseline , '.csv')
filename_percentile25 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_baseline , '/percentile25_onset_cell_', onset_baseline , '.csv')
filename_percentile75 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_baseline , '/percentile75_onset_cell_', onset_baseline , '.csv')
filename_percentile95 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_baseline , '/percentile95_onset_cell_', onset_baseline , '.csv')
  
filename_shp <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_baseline , '/shp')
layername_shp <- paste0('median_onset_cell_SHP_', onset_baseline )
    
median_cell_raw <- read.csv(filename_median)
percentile5_cell_raw <- read.csv(filename_percentile5)
percentile25_cell_raw <- read.csv(filename_percentile25)
percentile75_cell_raw <- read.csv(filename_percentile75)
percentile95_cell_raw <- read.csv(filename_percentile95)
    
cell_sf <- st_read(dsn = filename_shp, layer = layername_shp)
 
# CSV DATA -----------------------------------------------------------------------------------------------
# median cell
median_cell <- median_cell_raw %>% delete_cols_median_cell() %>%
                                      rename_cols_median_cell()
median_cell$plant_stat_type <- rep('median', nrow(median_cell))
  
  
# percentiles
percentile5_cell <- percentile5_cell_raw %>% rename_cols_percentile_cell()
percentile25_cell <- percentile25_cell_raw %>% rename_cols_percentile_cell()
percentile75_cell <- percentile75_cell_raw %>% rename_cols_percentile_cell()
percentile95_cell <- percentile95_cell_raw %>% rename_cols_percentile_cell()
  
# SF DATA ------------------------------------------------------------------------------------------------
  
# get cell_ID column for median
cell_sf$cell_ID <- median_cell$cell_ID
cell_sf$cell_ID <- sapply(as.character(cell_sf$cell_ID), clean_cell_ID)
  
# join median, percentile data to cell_sf
# cell_sf has median information, but copy it and put in percentile info for DC and SC plant
  
cell_sf$plant_stat_type <- rep("median", nrow(cell_sf))
  
cell_sf_percentile5 <- cell_sf
cell_sf_percentile5$SC_plant <- percentile5_cell$SC_plant
cell_sf_percentile5$DC_plant <- percentile5_cell$DC_plant
cell_sf_percentile5$plant_stat_type <- rep("percentile5", nrow(cell_sf_percentile5))
  
cell_sf_percentile25 <- cell_sf
cell_sf_percentile25$SC_plant <- percentile25_cell$SC_plant
cell_sf_percentile25$DC_plant <- percentile25_cell$DC_plant
cell_sf_percentile25$plant_stat_type <- rep("percentile25", nrow(cell_sf_percentile25))
  
cell_sf_percentile75 <- cell_sf
cell_sf_percentile75$SC_plant <- percentile75_cell$SC_plant
cell_sf_percentile75$DC_plant <- percentile75_cell$DC_plant
cell_sf_percentile75$plant_stat_type <- rep("percentile75", nrow(cell_sf_percentile75))

cell_sf_percentile95 <- cell_sf
cell_sf_percentile95$SC_plant <- percentile95_cell$SC_plant
cell_sf_percentile95$DC_plant <- percentile95_cell$DC_plant
cell_sf_percentile95$plant_stat_type <- rep("percentile95", nrow(cell_sf_percentile95))

cell_sf <- rbind(cell_sf, cell_sf_percentile5, cell_sf_percentile25, cell_sf_percentile75, cell_sf_percentile95)
  
cell_sf_tidy <- cell_sf %>% tidy_by_intensity_plant("SC_plant", "DC_plant") %>%
            dplyr::select(-c(SC_harvest, DC_harvest)) %>%
            categorize_regions_cell_sf_tidy() # categorize cells into four regions
  
cell_sf_tidy$year_index <- cell_sf_tidy$year - 2003
cell_sf_tidy$year_factor <- as.factor(cell_sf_tidy$year)
  
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy$delay <- cell_sf_tidy$plant - cell_sf_tidy$onset
  
# calculate quantiles of onset
onset_baseline_data <- cell_sf_tidy %>% 
                    mutate(onset_quantile_allyears = ntile(onset, 10))

print('onset_baseline done')

# FOR onset_third ------------------------------------------------------------------------------------------------------------------
# read and clean the data ---------------------------------------------------------------------------------------------------------
filename_median <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_third, '/median_onset_cell_', onset_third , '.csv')
filename_percentile5 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_third , '/percentile5_onset_cell_', onset_third , '.csv')
filename_percentile25 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_third , '/percentile25_onset_cell_', onset_third , '.csv')
filename_percentile75 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_third , '/percentile75_onset_cell_', onset_third , '.csv')
filename_percentile95 <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_third , '/percentile95_onset_cell_', onset_third , '.csv')
  
filename_shp <- paste0(first_folder,'/R-code-large-files/data_onset_', onset_third , '/shp')
layername_shp <- paste0('median_onset_cell_SHP_', onset_third )
    
median_cell_raw <- read.csv(filename_median)
percentile5_cell_raw <- read.csv(filename_percentile5)
percentile25_cell_raw <- read.csv(filename_percentile25)
percentile75_cell_raw <- read.csv(filename_percentile75)
percentile95_cell_raw <- read.csv(filename_percentile95)
    
cell_sf <- st_read(dsn = filename_shp, layer = layername_shp)
 
# CSV DATA -----------------------------------------------------------------------------------------------
# median cell
median_cell <- median_cell_raw %>% delete_cols_median_cell() %>%
                                      rename_cols_median_cell()
median_cell$plant_stat_type <- rep('median', nrow(median_cell))
  
# percentiles
percentile5_cell <- percentile5_cell_raw %>% rename_cols_percentile_cell()
percentile25_cell <- percentile25_cell_raw %>% rename_cols_percentile_cell()
percentile75_cell <- percentile75_cell_raw %>% rename_cols_percentile_cell()
percentile95_cell <- percentile95_cell_raw %>% rename_cols_percentile_cell()
  
# SF DATA ------------------------------------------------------------------------------------------------
  
# get cell_ID column for median
cell_sf$cell_ID <- median_cell$cell_ID
cell_sf$cell_ID <- sapply(as.character(cell_sf$cell_ID), clean_cell_ID)
  
# join median, percentile data to cell_sf
# cell_sf has median information, but copy it and put in percentile info for DC and SC plant
  
cell_sf$plant_stat_type <- rep("median", nrow(cell_sf))
  
cell_sf_percentile5 <- cell_sf
cell_sf_percentile5$SC_plant <- percentile5_cell$SC_plant
cell_sf_percentile5$DC_plant <- percentile5_cell$DC_plant
cell_sf_percentile5$plant_stat_type <- rep("percentile5", nrow(cell_sf_percentile5))
  
cell_sf_percentile25 <- cell_sf
cell_sf_percentile25$SC_plant <- percentile25_cell$SC_plant
cell_sf_percentile25$DC_plant <- percentile25_cell$DC_plant
cell_sf_percentile25$plant_stat_type <- rep("percentile25", nrow(cell_sf_percentile25))
  
cell_sf_percentile75 <- cell_sf
cell_sf_percentile75$SC_plant <- percentile75_cell$SC_plant
cell_sf_percentile75$DC_plant <- percentile75_cell$DC_plant
cell_sf_percentile75$plant_stat_type <- rep("percentile75", nrow(cell_sf_percentile75))

cell_sf_percentile95 <- cell_sf
cell_sf_percentile95$SC_plant <- percentile95_cell$SC_plant
cell_sf_percentile95$DC_plant <- percentile95_cell$DC_plant
cell_sf_percentile95$plant_stat_type <- rep("percentile95", nrow(cell_sf_percentile95))

cell_sf <- rbind(cell_sf, cell_sf_percentile5, cell_sf_percentile25, cell_sf_percentile75, cell_sf_percentile95)
  
cell_sf_tidy <- cell_sf %>% tidy_by_intensity_plant("SC_plant", "DC_plant") %>%
            dplyr::select(-c(SC_harvest, DC_harvest)) %>%
            categorize_regions_cell_sf_tidy() # categorize cells into four regions
  
cell_sf_tidy$year_index <- cell_sf_tidy$year - 2003
cell_sf_tidy$year_factor <- as.factor(cell_sf_tidy$year)
  
cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy$delay <- cell_sf_tidy$plant - cell_sf_tidy$onset
  
# calculate quantiles of onset
onset_third_data <- cell_sf_tidy %>% 
                    mutate(onset_quantile_allyears = ntile(onset, 10))

print('onset_third done')
```

Plot of within-year spatial variability for each onset definition

```{r}

# boxplot
ggplot(onset_oi_data) +
  geom_boxplot(aes(x=year_factor, y=onset)) +
  ggtitle(onset_oi) +
  ylim(0, 130) +
  theme_bw()

# group by year and onset_type, then calc median and stdev
onset_data_summarized_eachyear <- onset_oi_data %>% group_by(year_factor) %>%
                                             summarize(onset_mean = mean(onset),
                                                   onset_stdev = sd(onset)) %>%
                                             ungroup()

# barplot
ggplot(onset_data_summarized_eachyear) +
  geom_point(aes(x=year_factor, y=onset_stdev)) +
  ggtitle(paste('Spatial variability over the years', onset_oi)) +
  labs(x = 'year') +
  ylim(0, 15) +
  theme_bw()

```

Map of within-year spatial variability (averaged quantiles through the years) for onsets and planting

```{r}

# choose only one intensity and percentile for planting
intensity <- 'DC'
percentile <- 'median'

onset_oi_data_subset <- onset_oi_data[onset_oi_data$intensity == intensity & 
                                        onset_oi_data$plant_stat_type == percentile,]
onset_oi_data_subset <- onset_oi_data_subset %>% group_by(year_factor) %>%
  mutate(onset_quantile_eachyear = ntile(onset, 10),
         plant_quantile_eachyear = ntile(plant, 10))

# quantile_maps <- ggplot(onset_oi_data) +
#       geom_sf(aes(fill = onset_quantile_eachyear), color = NA) +
#       #scale_fill_viridis() +
#       scale_fill_gradient(low="black", high="blue") +
#       #scale_fill_brewer(palette="YlOrRd") +
#       ggtitle(paste("Onset quantile for individual years,", onset_type)) +
#       geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black",
#                    alpha = 0, linetype = 1) +
#       facet_wrap(~year_factor) +
#       theme_bw()
# 
# print(quantile_maps)

onset_oi_data_subset <- onset_oi_data_subset %>% ungroup()

# calculate time-averaged quantiles
# get cells from 2004, filter out all other cells from the other years
cellID_2004 <- onset_oi_data_subset[onset_oi_data_subset$year == 2004, "cell_ID"]
st_geometry(cellID_2004) <- NULL
onset_oi_data_subset_cells <- onset_oi_data_subset[onset_oi_data_subset$cell_ID %in% cellID_2004$cell_ID,]

# group by cell_ID and calculate mean onset
onset_oi_summarized <- onset_oi_data_subset_cells %>% group_by(cell_ID) %>%
                                             summarize(onset_quantile_median = median(onset_quantile_eachyear),
                                                   onset_quantile_mean = mean(onset_quantile_eachyear),
                                                   plant_quantile_median = median(plant_quantile_eachyear),
                                                   onset_mean = mean(onset),
                                                   plant_mean = mean(plant),
                                                   delay_mean = plant_mean - onset_mean) %>%
                                             ungroup()
onset_quantile_map_summary <- ggplot(onset_oi_summarized) +
      geom_sf(aes(fill = onset_quantile_median), color = NA) +
      #scale_fill_viridis() +
      scale_fill_gradient(low="black", high="blue") +
      #scale_fill_brewer(palette="YlOrRd") +
      ggtitle(paste("Median onset quantile, all years,", onset_oi)) +
      geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", 
                   alpha = 0, linetype = 1) +
      theme_bw()

# plot average onset (2004 - 2014)
onset_map_summary <- ggplot(onset_oi_summarized) +
      geom_sf(aes(fill = onset_mean), color = NA) +
      scale_fill_viridis() +
      #scale_fill_gradient(low="black", high="blue") +
      #scale_fill_brewer(palette="YlOrRd") +
      ggtitle(paste("Mean onset, all years,", onset_oi)) +
      geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", 
                   alpha = 0, linetype = 1) +
      theme_bw()

plant_quantile_map_summary <- ggplot(onset_oi_summarized) +
      geom_sf(aes(fill = plant_quantile_median), color = NA) +
      #scale_fill_viridis() +
      scale_fill_gradient(low="black", high="red") +
      #scale_fill_brewer(palette="YlOrRd") +
      ggtitle(paste("Median plant quantile, all years", intensity, percentile)) +
      geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", 
                   alpha = 0, linetype = 1) +
      theme_bw()

# calculate average DC delay between planting and onset, 2004 - 2014
delay_map_summary <- ggplot(onset_oi_summarized) +
      geom_sf(aes(fill = delay_mean), color = NA) +
      scale_fill_viridis(limits = c(0, 70)) +
      #scale_fill_gradient(low="black", high="blue") +
      #scale_fill_brewer(palette="YlOrRd") +
      ggtitle(paste("Mean delay, all years,", onset_oi, intensity)) +
      geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", 
                   alpha = 0, linetype = 1) +
      theme_bw()


#print(onset_quantile_map_summary)
#print(plant_quantile_map_summary)
print(onset_map_summary)
print(delay_map_summary)

```

Map of long-term spatial pattern in differences between onset definitions

```{r}

# compare onset_oi and onset_baseline
for (year in 2004:2014) {
  
  # onset_oi for given year
  onset_oi_year <- onset_oi_data[onset_oi_data$year == year,]
  onset_baseline_year <- onset_baseline_data[onset_baseline_data$year == year,]
  
  joined <- st_join(onset_oi_year, onset_baseline_year, largest = TRUE, suffix = c('_oi', '_baseline'))
  
  joined$onset_diff <- joined$onset_oi - joined$onset_baseline
  
  # assign joined to its own variable, for taking the mean of all onset_diff later
  
  result_name <- paste0('onset_diff_', year, '_sf')
  assign(result_name, joined)
  
  print(year)
  
  # onset_diff_plot <- ggplot(joined) +
  #       geom_sf(aes(fill = onset_diff), color = NA) +
  #       scale_fill_gradient(low="blue", high="red") +
  #       ggtitle(paste("Onset difference between", onset_oi, 'and', onset_baseline, year)) +
  #       geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black",
  #                    alpha = 0, linetype = 1) +
  #       theme_bw()
  # 
  # onset_oi_plot <- ggplot(onset_oi_year) +
  #       geom_sf(aes(fill = onset), color = NA) +
  #       #scale_fill_viridis() +
  #       scale_fill_gradient(low="black", high="blue") +
  #       #scale_fill_brewer(palette="YlOrRd") +
  #       ggtitle(paste("Onset,", onset_oi, year)) +
  #       geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black",
  #                    alpha = 0, linetype = 1) +
  #       theme_bw()
  # 
  # onset_baseline_plot <- ggplot(onset_baseline_year) +
  #       geom_sf(aes(fill = onset), color = NA) +
  #       #scale_fill_viridis() +
  #       scale_fill_gradient(low="black", high="blue") +
  #       #scale_fill_brewer(palette="YlOrRd") +
  #       ggtitle(paste("Onset,", onset_baseline, year)) +
  #       geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black",
  #                    alpha = 0, linetype = 1) +
  #       theme_bw()
  # 
  # print(onset_diff_plot)
  # print(onset_oi_plot)
  # print(onset_baseline_plot)
}
```

Join all the years into one dataframe, then take the mean across the columns. Do this stepwise (adding on year by year)
```{r}

# spatial join the onset_diff_2004_sf, etc to calculate the mean difference

joined_2years <- st_join(onset_diff_2004_sf, onset_diff_2005_sf, largest = TRUE, suffix = c('_2004', '_2005'))
joined_2years <- joined_2years[,c('onset_diff_2004', 'onset_diff_2005')]

joined_3years <- st_join(joined_2years, onset_diff_2006_sf, largest = TRUE)
joined_3years['onset_diff_2006'] <- joined_3years['onset_diff']
joined_3years <- joined_3years[,c('onset_diff_2004', 'onset_diff_2005', 'onset_diff_2006')]

joined_4years <- st_join(joined_3years, onset_diff_2007_sf, largest = TRUE)
joined_4years['onset_diff_2007'] <- joined_4years['onset_diff']
joined_4years <- joined_4years[,c('onset_diff_2004', 'onset_diff_2005', 'onset_diff_2006', 'onset_diff_2007')]

joined_5years <- st_join(joined_4years, onset_diff_2008_sf, largest = TRUE)
joined_5years['onset_diff_2008'] <- joined_5years['onset_diff']
joined_5years <- joined_5years[,c('onset_diff_2004', 'onset_diff_2005', 'onset_diff_2006', 'onset_diff_2007', 'onset_diff_2008')]

joined_6years <- st_join(joined_5years, onset_diff_2009_sf, largest = TRUE)
joined_6years['onset_diff_2009'] <- joined_6years['onset_diff']
joined_6years <- joined_6years[,c('onset_diff_2004', 'onset_diff_2005', 'onset_diff_2006', 'onset_diff_2007', 'onset_diff_2008', 'onset_diff_2009')]

joined_7years <- st_join(joined_6years, onset_diff_2010_sf, largest = TRUE)
joined_7years['onset_diff_2010'] <- joined_7years['onset_diff']
joined_7years <- joined_7years[,c('onset_diff_2004', 'onset_diff_2005', 'onset_diff_2006', 'onset_diff_2007', 'onset_diff_2008', 'onset_diff_2009', 'onset_diff_2010')]

joined_8years <- st_join(joined_7years, onset_diff_2011_sf, largest = TRUE)
joined_8years['onset_diff_2011'] <- joined_8years['onset_diff']
joined_8years <- joined_8years[,c('onset_diff_2004', 'onset_diff_2005', 'onset_diff_2006', 'onset_diff_2007', 'onset_diff_2008', 'onset_diff_2009', 'onset_diff_2010',
                                  'onset_diff_2011')]

joined_9years <- st_join(joined_8years, onset_diff_2012_sf, largest = TRUE)
joined_9years['onset_diff_2012'] <- joined_9years['onset_diff']
joined_9years <- joined_9years[,c('onset_diff_2004', 'onset_diff_2005', 'onset_diff_2006', 'onset_diff_2007', 'onset_diff_2008', 'onset_diff_2009', 'onset_diff_2010',
                                  'onset_diff_2011', 'onset_diff_2012')]

joined_10years <- st_join(joined_9years, onset_diff_2013_sf, largest = TRUE)
joined_10years['onset_diff_2013'] <- joined_10years['onset_diff']
joined_10years <- joined_10years[,c('onset_diff_2004', 'onset_diff_2005', 'onset_diff_2006', 'onset_diff_2007', 'onset_diff_2008', 'onset_diff_2009', 'onset_diff_2010',
                                  'onset_diff_2011', 'onset_diff_2012', 'onset_diff_2013')]

joined_11years <- st_join(joined_10years, onset_diff_2014_sf, largest = TRUE)
joined_11years['onset_diff_2014'] <- joined_11years['onset_diff']
joined_11years <- joined_11years[,c('onset_diff_2004', 'onset_diff_2005', 'onset_diff_2006', 'onset_diff_2007', 'onset_diff_2008', 'onset_diff_2009', 'onset_diff_2010',
                                  'onset_diff_2011', 'onset_diff_2012', 'onset_diff_2013', 'onset_diff_2014')]
```


```{r}

mean_of_rows <- function(row) {
  data <- row[c('onset_diff_2004', 'onset_diff_2005', 'onset_diff_2006', 'onset_diff_2007', 'onset_diff_2008', 'onset_diff_2009', 'onset_diff_2010',
                                  'onset_diff_2011', 'onset_diff_2012', 'onset_diff_2013', 'onset_diff_2014')]
  
  #st_geometry(data) <- NULL
  data <- as.numeric(as.vector(data))
  
  return(mean(data, na.rm = TRUE))
}

mean_onset_diff <- apply(joined_11years, 1, mean_of_rows) 

# add mean_onset_diff to sf for mapping
joined_11years['mean_onset_diff'] <- mean_onset_diff

mean_onset_diff_plot <- ggplot(joined_11years) +
        geom_sf(aes(fill = mean_onset_diff), color = NA) +
        scale_fill_gradient2(low="blue", high="red",  mid = "white", limits = c(-15, 15)) +
        ggtitle(paste("Onset diff bet", onset_oi, 'and', onset_baseline, 'all years')) +
        geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black",
                     alpha = 0, linetype = 1) +
        theme_bw()

print(mean_onset_diff_plot)
```

Calculate mean planting date across years for a given intensity and percentile

```{r}

intensity <- 'SC'
percentile <- 'median'

onset_oi_data_subset <- onset_oi_data[onset_oi_data$intensity == intensity & onset_oi_data$plant_stat_type == percentile,]

# spatial join each year's data to calculate the mean planting date
onset_oi_data_2004 <- onset_oi_data_subset[onset_oi_data_subset$year == 2004,]
onset_oi_data_2005 <- onset_oi_data_subset[onset_oi_data_subset$year == 2005,]
onset_oi_data_2006 <- onset_oi_data_subset[onset_oi_data_subset$year == 2006,]
onset_oi_data_2007 <- onset_oi_data_subset[onset_oi_data_subset$year == 2007,]
onset_oi_data_2008 <- onset_oi_data_subset[onset_oi_data_subset$year == 2008,]
onset_oi_data_2009 <- onset_oi_data_subset[onset_oi_data_subset$year == 2009,]
onset_oi_data_2010 <- onset_oi_data_subset[onset_oi_data_subset$year == 2010,]
onset_oi_data_2011 <- onset_oi_data_subset[onset_oi_data_subset$year == 2011,]
onset_oi_data_2012 <- onset_oi_data_subset[onset_oi_data_subset$year == 2012,]
onset_oi_data_2013 <- onset_oi_data_subset[onset_oi_data_subset$year == 2013,]
onset_oi_data_2014 <- onset_oi_data_subset[onset_oi_data_subset$year == 2014,]

joined_2years <- st_join(onset_oi_data_2004, onset_oi_data_2005, largest = TRUE, suffix = c('_2004', '_2005'))
joined_2years <- joined_2years[,c('plant_2004', 'plant_2005')]

joined_3years <- st_join(joined_2years, onset_oi_data_2006, largest = TRUE)
joined_3years['plant_2006'] <- joined_3years['plant']
joined_3years <- joined_3years[,c('plant_2004', 'plant_2005', 'plant_2006')]

joined_4years <- st_join(joined_3years, onset_oi_data_2007, largest = TRUE)
joined_4years['plant_2007'] <- joined_4years['plant']
joined_4years <- joined_4years[,c('plant_2004', 'plant_2005', 'plant_2006', 'plant_2007')]

joined_5years <- st_join(joined_4years, onset_oi_data_2008, largest = TRUE)
joined_5years['plant_2008'] <- joined_5years['plant']
joined_5years <- joined_5years[,c('plant_2004', 'plant_2005', 'plant_2006', 'plant_2007', 'plant_2008')]

joined_6years <- st_join(joined_5years, onset_oi_data_2009, largest = TRUE)
joined_6years['plant_2009'] <- joined_6years['plant']
joined_6years <- joined_6years[,c('plant_2004', 'plant_2005', 'plant_2006', 'plant_2007', 'plant_2008', 'plant_2009')]

joined_7years <- st_join(joined_6years, onset_oi_data_2010, largest = TRUE)
joined_7years['plant_2010'] <- joined_7years['plant']
joined_7years <- joined_7years[,c('plant_2004', 'plant_2005', 'plant_2006', 'plant_2007', 'plant_2008', 'plant_2009', 'plant_2010')]

joined_8years <- st_join(joined_7years, onset_oi_data_2011, largest = TRUE)
joined_8years['plant_2011'] <- joined_8years['plant']
joined_8years <- joined_8years[,c('plant_2004', 'plant_2005', 'plant_2006', 'plant_2007', 'plant_2008', 'plant_2009', 'plant_2010', 'plant_2011')]

joined_9years <- st_join(joined_8years, onset_oi_data_2012, largest = TRUE)
joined_9years['plant_2012'] <- joined_9years['plant']
joined_9years <- joined_9years[,c('plant_2004', 'plant_2005', 'plant_2006', 'plant_2007', 'plant_2008', 'plant_2009', 'plant_2010', 'plant_2011', 'plant_2012')]

joined_10years <- st_join(joined_9years, onset_oi_data_2013, largest = TRUE)
joined_10years['plant_2013'] <- joined_10years['plant']
joined_10years <- joined_10years[,c('plant_2004', 'plant_2005', 'plant_2006', 'plant_2007', 'plant_2008', 'plant_2009', 'plant_2010', 'plant_2011', 'plant_2012', 'plant_2013')]

joined_11years <- st_join(joined_10years, onset_oi_data_2014, largest = TRUE)
joined_11years['plant_2014'] <- joined_11years['plant']
joined_11years <- joined_11years[,c('plant_2004', 'plant_2005', 'plant_2006', 'plant_2007', 'plant_2008', 'plant_2009', 'plant_2010', 'plant_2011', 'plant_2012', 'plant_2013', 'plant_2014')]

```

```{r}

mean_of_rows_plant <- function(row) {
  data <- row[c('plant_2004', 'plant_2005', 'plant_2006', 'plant_2007', 'plant_2008', 'plant_2009', 'plant_2010', 'plant_2011', 'plant_2012', 'plant_2013', 'plant_2014')]
  
  #st_geometry(data) <- NULL
  data <- as.numeric(as.vector(data))
  
  return(mean(data, na.rm = TRUE))
}

mean_plant <- apply(joined_11years, 1, mean_of_rows_plant) 

# add mean_onset_diff to sf for mapping
joined_11years['mean_plant'] <- mean_plant

mean_plant_plot <- ggplot(joined_11years) +
        geom_sf(aes(fill = mean_plant), color = NA) +
        scale_fill_viridis(limits = c(70, 120)) +
        ggtitle(paste('mean plant, all years', intensity, percentile)) +
        geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black",
                     alpha = 0, linetype = 1) +
        theme_bw()

print(mean_plant_plot)

# calculate spatial variability metrics

# moran's I
library(spdep)
to_autocorrelation <- joined_11years
nb <- poly2nb(to_autocorrelation)
lw <- nb2listw(nb, zero.policy = TRUE)
moran_plant <- moran.mc(to_autocorrelation$mean_plant, lw, 999, zero.policy = TRUE)
print('moran I of mean plant')
print(moran_plant)

# standard deviation
print('standard deviation')
print(sd(joined_11years$mean_plant))

```

Timeseries of onset, averaged over space

```{r}

# error bars for spatial variability?

# group by year and onset_type, then calc median and stdev
onset_oi_summarized_eachyear <- onset_oi_data %>% group_by(year_factor) %>%
                                             summarize(onset_mean = mean(onset),
                                                   onset_stdev = sd(onset)) %>%
                                             ungroup()

onset_baseline_summarized_eachyear <- onset_baseline_data %>% group_by(year_factor) %>%
                                             summarize(onset_mean = mean(onset),
                                                   onset_stdev = sd(onset)) %>%
                                             ungroup()

onset_third_summarized_eachyear <- onset_third_data %>% group_by(year_factor) %>%
                                             summarize(onset_mean = mean(onset),
                                                   onset_stdev = sd(onset)) %>%
                                             ungroup()

st_geometry(onset_oi_summarized_eachyear) <- NULL
st_geometry(onset_baseline_summarized_eachyear) <- NULL
st_geometry(onset_third_summarized_eachyear) <- NULL

onset_oi_summarized_eachyear$onset_type <- onset_oi
onset_baseline_summarized_eachyear$onset_type <- onset_baseline
onset_third_summarized_eachyear$onset_type <- onset_third

onset_summarized <- rbind(onset_oi_summarized_eachyear, onset_baseline_summarized_eachyear, onset_third_summarized_eachyear)
onset_summarized$year <- as.numeric(levels(onset_summarized$year_factor))[onset_summarized$year_factor] #as.numeric(onset_summarized$year_factor)

# timeseries plot
ggplot(onset_summarized) +
  geom_line(aes(x=year, y=onset_mean, col = onset_type)) +
  geom_point(aes(x=year, y=onset_mean, col = onset_type)) +
  geom_errorbar(aes(ymin=onset_mean-onset_stdev, ymax=onset_mean+onset_stdev, x = year, col = onset_type), 
                position = position_dodge(width = 0.2)) +
  scale_x_continuous(breaks=c(2004, 2006, 2008, 2010, 2012, 2014)) +
  ggtitle('Mean onset') +
  labs(x = 'year') +
  ylim(10, 90) +
  theme_bw()

```

Robustness tests

```{r}

# eliminated predictors: repeat FE specification with eliminated predictors for the chosen onset definition. report onset coefficient for each intensity, percentile

elimpred_results <- data.frame(intensity = character(0), percentile = character(0),
                               onset_coef = numeric(0), onset_stderr = numeric(0), 
                               model_type = character(0))

for (intensity in c("SC", "DC")) {
    for (percentile in c('percentile5', 'percentile25', 'median', 'percentile75', 'percentile95')) {

      print(percentile)
      data_subset <- onset_oi_data[(onset_oi_data$plant_stat_type == percentile) & (onset_oi_data$intensity == intensity), ]
      data_subset_panel <- pdata.frame(data_subset, index = c("cell_ID"))
          
      fe_model <- plm(plant ~ onset + year, data = data_subset_panel, model = "within")
      fe_model_elimpred <- plm(plant ~ onset, data = data_subset_panel, model = "within")
      
      ols_model <- lm(plant ~ onset + year + lat + lon + region, data = data_subset)
      ols_model_elimpred <- lm(plant ~ onset, data = data_subset)
      
      # get coefficients
      fe_onset_coef <- fe_model$coefficients["onset"]
      fe_elimpred_onset_coef <- fe_model_elimpred$coefficients["onset"]
      ols_onset_coef <- ols_model$coefficients["onset"]
      ols_elimpred_onset_coef <- ols_model_elimpred$coefficients["onset"]
      
      fe_onset_stderr <- summary(fe_model)$coefficients['onset', 'Std. Error']
      fe_elimpred_onset_stderr <- summary(fe_model_elimpred)$coefficients['onset', 'Std. Error']
      ols_onset_stderr <- summary(ols_model)$coefficients['onset', 'Std. Error']
      ols_elimpred_onset_stderr <- summary(ols_model_elimpred)$coefficients['onset', 'Std. Error']
      
      results <- data.frame(intensity = rep(intensity, 4), percentile = rep(percentile, 4),
                            onset_coef = c(fe_onset_coef, fe_elimpred_onset_coef,
                                           ols_onset_coef, ols_elimpred_onset_coef),
                            onset_stderr = c(fe_onset_stderr, fe_elimpred_onset_stderr,
                                             ols_onset_stderr, ols_elimpred_onset_stderr),
                            model_type = c('fe', 'fe_elimpred', 'ols', 'ols_elimpred'))
      
      elimpred_results <- rbind(elimpred_results, results)
    }
}

print(elimpred_results)
# change the levels of the percentile and cropping intensity for plotting
levels(elimpred_results$percentile) <- c('5th percentile', '25th percentile', '50th percentile', '75th percentile', '95th percentile')
levels(elimpred_results$intensity) <- c('Single cropped', 'Double cropped')

# different degrees of eliminated predictors on x axis, and onset coef on y axis

elimpred_plot <- ggplot(elimpred_results) +
  geom_point(aes(x = model_type, y = onset_coef)) +
  geom_errorbar(aes(ymin=onset_coef-onset_stderr, ymax=onset_coef+onset_stderr, x = model_type)) +
  facet_wrap(intensity ~ percentile,  ncol=5) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90))

print(elimpred_plot)
```
