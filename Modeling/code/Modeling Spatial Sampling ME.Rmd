---
title: "Compare OLS, FE, RE, ME models of spatially sampled data"
output: html_document
---


## read data

```{r}

os_system <- 'mac' # mac for laptop or windows for desktop
if (os_system == 'windows') {first_folder <- 'E:'}
if (os_system == 'mac') {first_folder <- '~/Documents'}

library(ggplot2)
library(tidyverse)
library(broom)
library(dplyr)
library(plyr)
library(rgdal)
library(rgeos)
library(raster)
library(sf)
library(sp)
library(tmap)
library(viridis)
library(spdep)
library(spatialreg)
library(lmtest)
library(Metrics) # for rmse
library(leaflet)
library(leaps) # stepwise model selection

#E:/R-code/Modeling/code/FCN_clean_csvs.R
#~/Documents/R-code
source(paste0(first_folder, '/R-code2/Modeling/code/FCN_clean_csvs.R'))
source(paste0(first_folder, '/R-code2/Modeling/code/FCN_plotting.R'))
source(paste0(first_folder, '/R-code2/Modeling/code/FCN_sample_data.R'))
source(paste0(first_folder, '/R-code2/Modeling/code/FCN_run_model_spatial_sampled.R')) # OLS only
source(paste0(first_folder, '/R-code2/Modeling/code/FCN_run_any_model_spatial_sampled.R')) # OLS, FE, RE and ME

onset_type <- 'freq_8_persiann' #'AA_25_chirps_ATchirps5km' # 'Gabriel_onset'

if (onset_type != 'Gabriel_onset') {
  filename_median <- paste0(first_folder, '/R-code-large-files/data_onset_', onset_type, '/median_onset_cell_', onset_type, '.csv')
  filename_percentile5 <- paste0(first_folder, '/R-code-large-files/data_onset_', onset_type, '/percentile5_onset_cell_', onset_type, '.csv')
  filename_percentile25 <- paste0(first_folder, '/R-code-large-files/data_onset_', onset_type, '/percentile25_onset_cell_', onset_type, '.csv')

  filename_shp<- paste0(first_folder, '/R-code-large-files/data_onset_', onset_type, '/shp')
  layername_shp <- paste0('median_onset_cell_SHP_', onset_type)
  
  median_cell_raw <- read.csv(filename_median)
  percentile5_cell_raw <- read.csv(filename_percentile5)
  percentile25_cell_raw <- read.csv(filename_percentile25)
  
  cell_sf <- st_read(dsn = filename_shp, layer = layername_shp)
}

if (onset_type == 'Gabriel_onset') {
  median_cell_raw <- read.csv(paste0(first_folder, '/R-code2/Modeling/data/median_onset_cell_v3.csv'))
  percentile5_cell_raw <- read.csv(paste0(first_folder, '/R-code2/Modeling/data/percentile5_onset_cell_v3.csv'))
  percentile25_cell_raw <- read.csv(paste0(first_folder, '/R-code2/Modeling/data/percentile25_onset_cell_v3.csv'))
  
  cell_sf <- st_read(dsn = paste0(first_folder, '/R-code2/Modeling/data/shp/median_onset_cell_v3', layer = 'median_onset_cell_SHP_v3'))
}


MT_outline <- readOGR(dsn = paste0(first_folder, '/R-code2/Modeling/data/shp/MatoGrossoOutline'), layer = 'MatoGrossoOutline')
crs(MT_outline) <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")

grid_1deg <- readOGR(dsn = paste0(first_folder, '/R-code2/Modeling/data/shp/grid_1deg'), layer = 'grid_1deg')
munis <- readOGR(dsn = paste0(first_folder, '/R-code2/Modeling/data/shp/munis'), layer = 'munis_SHP')
crs(munis) <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")

# read in all the onsets. only the csv, not shp
all_onset_types <- c('Gabriel_onset', 'AA_2_persiann', 'AA_3_persiann', 
                      'AA_25_persiann', 'AA_25_chirps_ATgabriel25km', 'AA_25_persiann_ATgabriel25km',
                     'freq_5_persiann', 'freq_8_persiann', 'freq_10_persiann', 'freq_12_persiann',
                     'monsoon_30_persiann', 'monsoon_40_persiann',
                     'pentad_8_persiann', 'pentad_10_persiann', 'pentad_15_persiann',
                     'rangethres_10_15_15_30_persiann', 'rangethres_10_15_15_40_persiann',
                     'rangethres_10_15_20_20_persiann', 'rangethres_10_15_20_30_persiann',
                     'rangethres_10_15_30_40_persiann', 'thres_10_persiann')
# didn't do:  'AA_25_chirps_ATchirps5km'
```

## read and clean spatial data

```{r}

# CSV DATA -----------------------------------------------------------------------------------------------------------------
# median cell
median_cell <- median_cell_raw %>% delete_cols_median_cell() %>%
                                    rename_cols_median_cell()

median_cell$plant_stat_type <- rep('median', nrow(median_cell))


# percentiles
percentile5_cell <- percentile5_cell_raw %>% rename_cols_percentile_cell()
percentile25_cell <- percentile25_cell_raw %>% rename_cols_percentile_cell()

# SF DATA ------------------------------------------------------------------------------------------------

# get cell_ID column for median
cell_sf$cell_ID <- median_cell$cell_ID
cell_sf$cell_ID <- sapply(as.character(cell_sf$cell_ID), clean_cell_ID)

# join median, percentile data to cell_sf
# cell_sf has median information, but copy it and put in percentile info for DC and SC plant

cell_sf$plant_stat_type <- rep("median", nrow(cell_sf))

cell_sf_percentile5 <- cell_sf
cell_sf_percentile5$SC_plant <- percentile5_cell$SC_plant
cell_sf_percentile5$DC_plant <- percentile5_cell$DC_plant
cell_sf_percentile5$plant_stat_type <- rep("percentile5", nrow(cell_sf_percentile5))

cell_sf_percentile25 <- cell_sf
cell_sf_percentile25$SC_plant <- percentile25_cell$SC_plant
cell_sf_percentile25$DC_plant <- percentile25_cell$DC_plant
cell_sf_percentile25$plant_stat_type <- rep("percentile25", nrow(cell_sf_percentile25))

cell_sf <- rbind(cell_sf, cell_sf_percentile5, cell_sf_percentile25)

cell_sf_tidy <- cell_sf %>% tidy_by_intensity_plant("SC_plant", "DC_plant") %>%
            #tidy_by_intensity_delay("SC_delay", "DC_delay") %>%
            dplyr::select(-c(SC_harvest, DC_harvest)) %>%
            categorize_regions_cell_sf_tidy() # categorize cells into four regions

cell_sf_tidy$year_index <- cell_sf_tidy$year - 2003
cell_sf_tidy$year_factor <- as.factor(cell_sf_tidy$year)

cell_sf_tidy <- cell_sf_tidy %>%  drop_na
cell_sf_tidy$delay <- cell_sf_tidy$plant - cell_sf_tidy$onset

# label which cells were planted before onset and filter for only before onset
cell_sf_tidy$beforeonset <- ifelse(cell_sf_tidy$onset > cell_sf_tidy$plant, 1, 0)
cell_sf_tidy <-  cell_sf_tidy[cell_sf_tidy$beforeonset == 0,]

# split into SC and DC cells
cell_sf_tidy_SC <- cell_sf_tidy[cell_sf_tidy$intensity == "SC",]
cell_sf_tidy_DC <- cell_sf_tidy[cell_sf_tidy$intensity == "DC",]
```

## compare model output for specifications

```{r}

library(plm) # for FE and FE
library(lme4) # for lmer()

## OLS
# ols_results <- run_OLS(full_data = cell_sf_tidy_DC,
#                         predictors = c("onset",
#                           "lat", "region", # for spatial effects
#                           "year_index" # for time effects
#                           ),
#                     y.var = "plant", plant_stat = "median",
#                     grid_size = 0.75, lat_offset = 0, lon_offset = 0, agg_scheme = FALSE,
#                     plot_samples = FALSE, plot_model_evals = TRUE,
#                     year_oi = 2012, do_elim_year = FALSE,
#                     chosen_intensity = "DC")
# 
# print(ols_results)

# FE
source('E:/R-code2/Modeling/code/FCN_run_any_model_spatial_sampled.R') # OLS, FE, RE and ME
fe_results <- run_any_model(full_data = cell_sf_tidy_DC, model_type = "FE", predictors = c("onset", "year_index"), 
                            ME_randomEffects = character(0), FE_RE_effect = c("cell_ID"),
                            y.var = "plant", plant_stat = "median",
                            grid_size = 0.75, lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, 
                            plot_samples = FALSE, plot_model_evals = TRUE, year_oi = 2012, do_elim_year = TRUE,
                            chosen_intensity = "DC")

print(fe_results)
```

## OLS

```{r}

plant_stat_types <- c("median", "percentile5", "percentile25")

# set up data frame to store model results for all models
ols_results <- data.frame(plant_stat_type = numeric(0),
                      intensity = numeric(0),
                      model_type = numeric(0),
                      onset_coef = numeric(0),
                      onset_std_err = numeric(0),
                      year_treatment = character(0),
                      lat_treatment = character(0),
                      region_treatment = character(0),
                      cell_treatment = character(0),
                      model_type = character(0))

for (plant_stat_type in plant_stat_types) {

  print(plant_stat_type)
  SC_output <- run_OLS(full_data = cell_sf_tidy_SC,
                        predictors = c("onset",
                          "lat", "lon", "region", # for spatial effects
                          "year_index" # for time effects
                          ),
                    y.var = "plant", plant_stat = plant_stat_type,
                    grid_size = 0.75, lat_offset = 0, lon_offset = 0, agg_scheme = FALSE,
                    plot_samples = FALSE, plot_model_evals = FALSE,
                    year_oi = 2012, do_elim_year = FALSE,
                    chosen_intensity = "SC")
  
  DC_output <- run_OLS(full_data = cell_sf_tidy_DC,
                        predictors = c("onset",
                          "lat", "lon", "region", # for spatial effects
                          "year_index" # for time effects
                          ),
                    y.var = "plant", plant_stat = plant_stat_type,
                    grid_size = 0.75, lat_offset = 0, lon_offset = 0, agg_scheme = FALSE,
                    plot_samples = FALSE, plot_model_evals = FALSE,
                    year_oi = 2012, do_elim_year = FALSE,
                    chosen_intensity = "DC")
    
  print(c(plant_stat_type, "SC", "OLS", as.numeric(SC_output$onset_coef), as.numeric(SC_output$onset_std_err)))
  
  updated_results <- data.frame(plant_stat_type = c(plant_stat_type, plant_stat_type),
                                intensity = c("SC", "DC"),
                                model_type = c("OLS", "OLS"),
                                onset_coef = c(as.numeric(SC_output$onset_coef), as.numeric(DC_output$onset_coef)),
                                onset_std_err = c(as.numeric(SC_output$onset_std_err), as.numeric(DC_output$onset_std_err)),
                                year_treatment = c('reg', 'reg'),
                                lat_treatment = c('reg', 'reg'),
                                region_treatment = c('reg', 'reg'),
                                cell_treatment = c('none', 'none'))
  ols_results <- rbind(ols_results, updated_results)
}

print(ols_results)

```

## FE and prediction bias

```{r}

library(plm) # for FE and FE

plant_stat_type = 'percentile25'
chosen_grid_size = 0.75

# sample from full data and turn into data frame
sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = chosen_grid_size,
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
st_geometry(sampled_SC) <- NULL

sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = chosen_grid_size,
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
st_geometry(sampled_DC) <- NULL

# for plm, first set data as panel data
panel_SC <- pdata.frame(sampled_SC,index = c("cell_ID"))
panel_DC <- pdata.frame(sampled_DC,index = c("cell_ID"))

# FE
fe_result_SC <- plm(plant ~ onset + year_index, data = panel_SC, model = "within")
fe_result_DC <- plm(plant ~ onset + year_index, data = panel_DC, model = "within")

#
print(summary(fe_result_SC))
print(summary(fe_result_DC))

# save residual and observed
error_df_DC <- data.frame(residual = fe_result_DC$residuals,
                       observed = sampled_DC$plant)
error_df_SC <- data.frame(residual = fe_result_SC$residuals,
                       observed = sampled_SC$plant)

# model residual vs observed, look at slope as measure of bias
error_model_DC <- lm(residual ~ observed, data = error_df_DC)
bias_measure_DC <- error_model_DC$coefficients['observed']

error_model_SC <- lm(residual ~ observed, data = error_df_SC)
bias_measure_SC <- error_model_SC$coefficients['observed']

plot(error_df_DC$observed, error_df_DC$residual, main = 'DC')
plot(error_df_SC$observed, error_df_SC$residual, main = 'SC')

plot(sampled_DC$onset, error_df_DC$residual, main = 'DC')
plot(sampled_SC$onset, error_df_SC$residual, main = 'SC')

plot(sampled_DC$year, error_df_DC$residual, main = 'DC')
plot(sampled_SC$year, error_df_SC$residual, main = 'SC')

plot(sampled_DC$plant, sampled_DC$plant - error_df_DC$residual, main = 'DC, obs vs pred')
abline(a = 0, b = 1)
plot(sampled_SC$plant, sampled_SC$plant - error_df_SC$residual, main = 'SC, obs vs pred')
abline(a = 0, b = 1)

plot(sampled_DC$plant - mean(sampled_DC$plant), pmodel.response(fe_result_DC, sampled_DC), main = 'DC, obs vs pred')
abline(a = 0, b = 1)
plot(sampled_SC$plant - mean(sampled_SC$plant), pmodel.response(fe_result_SC, sampled_SC), main = 'SC, obs vs pred')
abline(a = 0, b = 1)

# extract fixed effects
fe_SC_vector <- plm::fixef(fe_result_SC)
fe_DC_vector <- plm::fixef(fe_result_DC)
# define dataframe for joining
fe_SC <- data.frame(cell_ID = names(fe_SC_vector),
                    fe = fe_SC_vector)
fe_DC <- data.frame(cell_ID = names(fe_DC_vector),
                    fe = fe_DC_vector)

# resample, keeping geometry info
sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = chosen_grid_size,
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = chosen_grid_size,
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)

# add residual
sampled_DC$residuals <- fe_result_DC$residuals

# join
sampled_SC <- merge(sampled_SC, fe_SC, by = "cell_ID")
sampled_DC <- merge(sampled_DC, fe_DC, by = "cell_ID")

# plot fe
year <- 2014 # all years will be the same for fixed effects
sampled_SC_year <- sampled_SC[sampled_SC$year == year, ]
sampled_DC_year <- sampled_DC[sampled_DC$year == year, ]

fe_SC_map <- ggplot(sampled_SC_year) +
  geom_sf(aes(fill = fe)) +
  scale_fill_viridis() +
  ggtitle("Fixed effects for SC") +
  geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", alpha = 0, linetype = 1) +
  theme_bw()

fe_DC_map <- ggplot(sampled_DC_year) +
  geom_sf(aes(fill = fe)) +
  scale_fill_viridis() +
  ggtitle("Fixed effects for DC") +
  geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", alpha = 0, linetype = 1) +
  theme_bw()

print(fe_SC_map)
print(fe_DC_map)

# map residual in 2014

resid_DC_map <- ggplot(sampled_DC_year) +
  geom_sf(aes(fill = residuals), color = NA) +
  scale_fill_viridis() +
  ggtitle(paste("FE model, fit all cells, Residual for DC,", year)) +
  geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", alpha = 0, linetype = 1) +
  theme_bw()

print(resid_DC_map)

print(onset_type)

print('bias measure, DC')
print(bias_measure_DC)
print('bias measure, SC')
print(bias_measure_SC)


```

## model north and south separately, for ALL cells. Compare to modeling entire state at the same time for ALL cells

```{r}

# fit all cells, otherwise south won't have enough points
library(plm) # for FE and FE

plant_stat_type = 'percentile25'

cell_sf_tidy_DC_north <- cell_sf_tidy[cell_sf_tidy$region != "south" & cell_sf_tidy$intensity == "DC",]
cell_sf_tidy_DC_south <- cell_sf_tidy[cell_sf_tidy$region == "south" & cell_sf_tidy$intensity == "DC",]


# sample from full data and turn into data frame
sampled_DC_north <- cell_sf_tidy_DC_north[cell_sf_tidy_DC_north$plant_stat_type == plant_stat_type, ]
st_geometry(sampled_DC_north) <- NULL
sampled_DC_south <- cell_sf_tidy_DC_south[cell_sf_tidy_DC_south$plant_stat_type == plant_stat_type, ]
st_geometry(sampled_DC_south) <- NULL

# for plm, first set data as panel data
panel_DC_north <- pdata.frame(sampled_DC_north,index = c("cell_ID"))
panel_DC_south <- pdata.frame(sampled_DC_south,index = c("cell_ID"))

# FE
fe_result_DC_north <- plm(plant ~ onset + year_index, data = panel_DC_north, model = "within")
fe_result_DC_south <- plm(plant ~ onset + year_index, data = panel_DC_south, model = "within")

# sample again and keep geometry
sampled_DC_north <- cell_sf_tidy_DC_north[cell_sf_tidy_DC_north$plant_stat_type == plant_stat_type, ]
sampled_DC_south <- cell_sf_tidy_DC_south[cell_sf_tidy_DC_south$plant_stat_type == plant_stat_type, ]

sampled_DC_north$residuals <- fe_result_DC_north$residuals
sampled_DC_south$residuals <- fe_result_DC_south$residuals

year <- 2014
sampled_DC_north_year <- sampled_DC_north[sampled_DC_north$year == year, ]
sampled_DC_south_year <- sampled_DC_south[sampled_DC_south$year == year, ]
sampled_DC_northsouth_year <- rbind(sampled_DC_north_year, sampled_DC_south_year)

resid_DC_northsouth_map <- ggplot(sampled_DC_northsouth_year) +
  geom_sf(aes(fill = residuals), color = NA) +
  scale_fill_viridis() +
  ggtitle(paste("FE model, fit north south separately, Residual for DC,", year)) +
  geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", alpha = 0, linetype = 1) +
  theme_bw()

resid_DC_north_map <- ggplot(sampled_DC_north_year) +
  geom_sf(aes(fill = residuals), color = NA) +
  scale_fill_viridis() +
  ggtitle(paste("FE model, fit north only, Residual for DC,", year)) +
  geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", alpha = 0, linetype = 1) +
  theme_bw()

resid_DC_south_map <- ggplot(sampled_DC_south_year) +
  geom_sf(aes(fill = residuals), color = NA) +
  scale_fill_viridis() +
  ggtitle(paste("FE model, fit south only, Residual for DC,", year)) +
  geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", alpha = 0, linetype = 1) +
  theme_bw()

print(resid_DC_north_map)
print(resid_DC_south_map)
print(resid_DC_northsouth_map)

# compare to residual when training on all data

cell_sf_tidy_DC <- cell_sf_tidy[cell_sf_tidy$intensity == "DC",]

# sample from full data and turn into data frame
sampled_DC <- cell_sf_tidy_DC[cell_sf_tidy_DC$plant_stat_type == plant_stat_type,]
st_geometry(sampled_DC) <- NULL

# for plm, first set data as panel data
panel_DC <- pdata.frame(sampled_DC,index = c("cell_ID"))

# FE
fe_result_DC <- plm(plant ~ onset + year_index, data = panel_DC, model = "within")

# sample again and keep geometry
sampled_DC <- cell_sf_tidy_DC[cell_sf_tidy_DC$plant_stat_type == plant_stat_type,]

sampled_DC$residuals <- fe_result_DC$residuals

# extract fixed effects
fe_DC_vector <- plm::fixef(fe_result_DC)
# define dataframe for joining
fe_DC <- data.frame(cell_ID = names(fe_DC_vector),
                    fe = fe_DC_vector)

sampled_DC <- merge(sampled_DC, fe_DC, by = "cell_ID")

# plot fe
year <- 2014 # all years will be the same for fixed effects

sampled_DC_year <- sampled_DC[sampled_DC$year == year, ]


fe_DC_map <- ggplot(sampled_DC_year) +
  geom_sf(aes(fill = fe), color = NA) +
  scale_fill_viridis() +
  ggtitle("Fixed effects for DC") +
  geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", alpha = 0, linetype = 1) +
  theme_bw()

resid_DC_map <- ggplot(sampled_DC_year) +
  geom_sf(aes(fill = residuals), color = NA) +
  scale_fill_viridis() +
  ggtitle(paste("FE model, fit all cells, Residual for DC,", year)) +
  geom_polygon(data = MT_outline, aes(x = long, y = lat), color = "black", alpha = 0, linetype = 1) +
  theme_bw()

print(fe_DC_map)
print(resid_DC_map)
```

## FE model
```{r}
library(plm) # for FE and FE

# sample from full data and turn into data frame
sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = "median", grid_size = 0.75,
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
st_geometry(sampled_SC) <- NULL

sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = "median", grid_size = 0.75,
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
st_geometry(sampled_DC) <- NULL

# for plm, first set data as panel data
panel_SC <- pdata.frame(sampled_SC,index = c("cell_ID","year_index"))
panel_DC <- pdata.frame(sampled_DC,index = c("cell_ID","year_index"))

# FE
fe_result_SC <- plm(plant ~ onset + lat + lon + region, data = panel_SC, model = "within")
fe_result_DC <- plm(plant ~ onset + lat + lon + region, data = panel_DC, model = "within")

print(fe_result_SC)
print(fe_result_DC)

# set up data frame to store model results for all models
fe_results <- data.frame(plant_stat_type = numeric(0),
                      intensity = numeric(0),
                      model_type = numeric(0),
                      onset_coef = numeric(0),
                      onset_std_err = numeric(0),
                      year_treatment = character(0),
                      lat_treatment = character(0),
                      region_treatment = character(0),
                      cell_treatment = character(0),
                      model_type = character(0))

############# model for (1) cell_ID and year_index as FE in panel, (2) onset as predictor ####################################
for (plant_stat_type in plant_stat_types) {
  sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = 0.75, 
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_SC) <- NULL
  
  sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = 0.75, 
                   lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_DC) <- NULL

  panel_SC <- pdata.frame(sampled_SC,index = c("cell_ID","year_index")) 
  panel_DC <- pdata.frame(sampled_DC,index = c("cell_ID","year_index")) 

  SC_output <- plm(plant ~ onset, data = panel_SC, model = "within")
  DC_output <- plm(plant ~ onset, data = panel_DC, model = "within")
  
  SC_onset <- summary(SC_output)$coefficients['onset',]['Estimate']
  SC_onset_stderr <- summary(SC_output)$coefficients['onset',]['Std. Error']
  DC_onset <- summary(DC_output)$coefficients['onset',]['Estimate']
  DC_onset_stderr <- summary(DC_output)$coefficients['onset',]['Std. Error']
  
  updated_results <- data.frame(plant_stat_type = c(plant_stat_type, plant_stat_type),
                                intensity = c("SC", "DC"),
                                model_type = c("FE", "FE"),
                                onset_coef = c(as.numeric(SC_onset), as.numeric(DC_onset)),
                                onset_std_err = c(as.numeric(SC_onset_stderr), as.numeric(DC_onset_stderr)),
                                year_treatment = c('panel', 'panel'),
                                lat_treatment = c('none', 'none'),
                                region_treatment = c('none', 'none'),
                                cell_treatment = c('panel', 'panel'))
  fe_results <- rbind(fe_results, updated_results)
}

############# model for (1) cell_ID and year_index as FE in panel, (2) onset and year_index as predictor ####################################
for (plant_stat_type in plant_stat_types) {
  sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = 0.75, 
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_SC) <- NULL
  
  sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = 0.75, 
                   lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_DC) <- NULL

  panel_SC <- pdata.frame(sampled_SC,index = c("cell_ID", "year_index")) 
  panel_DC <- pdata.frame(sampled_DC,index = c("cell_ID", "year_index")) 

  SC_output <- plm(plant ~ onset + year_index, data = panel_SC, model = "within")
  DC_output <- plm(plant ~ onset + year_index, data = panel_DC, model = "within")
  
  SC_onset <- summary(SC_output)$coefficients['onset',]['Estimate']
  SC_onset_stderr <- summary(SC_output)$coefficients['onset',]['Std. Error']
  DC_onset <- summary(DC_output)$coefficients['onset',]['Estimate']
  DC_onset_stderr <- summary(DC_output)$coefficients['onset',]['Std. Error']
  
  updated_results <- data.frame(plant_stat_type = c(plant_stat_type, plant_stat_type),
                                intensity = c("SC", "DC"),
                                model_type = c("FE", "FE"),
                                onset_coef = c(as.numeric(SC_onset), as.numeric(DC_onset)),
                                onset_std_err = c(as.numeric(SC_onset_stderr), as.numeric(DC_onset_stderr)),
                                year_treatment = c('panel_reg', 'panel_reg'),
                                lat_treatment = c('none', 'none'),
                                region_treatment = c('none', 'none'),
                                cell_treatment = c('panel', 'panel'))
  fe_results <- rbind(fe_results, updated_results)
}

############# model for (1) cell_ID as FE in panel, (2) onset and year_index as predictor ####################################
for (plant_stat_type in plant_stat_types) {
  sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = 0.75, 
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_SC) <- NULL
  
  sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = 0.75, 
                   lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_DC) <- NULL

  panel_SC <- pdata.frame(sampled_SC,index = c("cell_ID")) 
  panel_DC <- pdata.frame(sampled_DC,index = c("cell_ID")) 

  SC_output <- plm(plant ~ onset + year_index, data = panel_SC, model = "within")
  DC_output <- plm(plant ~ onset + year_index, data = panel_DC, model = "within")
  
  SC_onset <- summary(SC_output)$coefficients['onset',]['Estimate']
  SC_onset_stderr <- summary(SC_output)$coefficients['onset',]['Std. Error']
  DC_onset <- summary(DC_output)$coefficients['onset',]['Estimate']
  DC_onset_stderr <- summary(DC_output)$coefficients['onset',]['Std. Error']
  
  updated_results <- data.frame(plant_stat_type = c(plant_stat_type, plant_stat_type),
                                intensity = c("SC", "DC"),
                                model_type = c("FE", "FE"),
                                onset_coef = c(as.numeric(SC_onset), as.numeric(DC_onset)),
                                onset_std_err = c(as.numeric(SC_onset_stderr), as.numeric(DC_onset_stderr)),
                                year_treatment = c('reg', 'reg'),
                                lat_treatment = c('none', 'none'),
                                region_treatment = c('none', 'none'),
                                cell_treatment = c('panel', 'panel'))
  fe_results <- rbind(fe_results, updated_results)
}

print(fe_results)
```

## RE model

```{r}
library(plm) # for FE and FE

# sample from full data and turn into data frame
sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = "median", grid_size = 0.75,
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
st_geometry(sampled_SC) <- NULL

sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = "median", grid_size = 0.75,
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
st_geometry(sampled_DC) <- NULL

# for plm, first set data as panel data
panel_SC <- pdata.frame(sampled_SC,index = c("cell_ID", "year_index"))
panel_DC <- pdata.frame(sampled_DC,index = c("cell_ID", "year_index"))

# FE
re_result_SC <- plm(plant ~ onset + lat + region + year_index, data = panel_SC, model = "random")
re_result_DC <- plm(plant ~ onset + lat + region + year_index, data = panel_DC, model = "random")

print(re_result_SC)
print(re_result_DC)

# set up data frame to store model results for all models
re_results <- data.frame(plant_stat_type = numeric(0),
                      intensity = numeric(0),
                      model_type = numeric(0),
                      onset_coef = numeric(0),
                      onset_std_err = numeric(0),
                      year_treatment = character(0),
                      lat_treatment = character(0),
                      region_treatment = character(0),
                      cell_treatment = character(0),
                      model_type = character(0))

############# model for (1) cell_ID and year_index as FE in panel, (2) onset, region, lat as predictor ####################################
for (plant_stat_type in plant_stat_types) {
  sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = 0.75, 
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_SC) <- NULL
  
  sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = 0.75, 
                   lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_DC) <- NULL

  panel_SC <- pdata.frame(sampled_SC,index = c("cell_ID","year_index")) 
  panel_DC <- pdata.frame(sampled_DC,index = c("cell_ID","year_index")) 

  SC_output <- plm(plant ~ onset + lat + region, data = panel_SC, model = "random")
  DC_output <- plm(plant ~ onset + lat + region, data = panel_DC, model = "random")
  
  SC_onset <- summary(SC_output)$coefficients['onset',]['Estimate']
  SC_onset_stderr <- summary(SC_output)$coefficients['onset',]['Std. Error']
  DC_onset <- summary(DC_output)$coefficients['onset',]['Estimate']
  DC_onset_stderr <- summary(DC_output)$coefficients['onset',]['Std. Error']
  
  updated_results <- data.frame(plant_stat_type = c(plant_stat_type, plant_stat_type),
                                intensity = c("SC", "DC"),
                                model_type = c("RE", "RE"),
                                onset_coef = c(as.numeric(SC_onset), as.numeric(DC_onset)),
                                onset_std_err = c(as.numeric(SC_onset_stderr), as.numeric(DC_onset_stderr)),
                                year_treatment = c('panel', 'panel'),
                                lat_treatment = c('reg', 'reg'),
                                region_treatment = c('reg', 'reg'),
                                cell_treatment = c('panel', 'panel'))
  re_results <- rbind(re_results, updated_results)
}

############# model for (1) cell_ID and year_index as FE in panel, (2) onset, region, lat, year_index as predictor ####################################
for (plant_stat_type in plant_stat_types) {
  sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = 0.75, 
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_SC) <- NULL
  
  sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = 0.75, 
                   lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_DC) <- NULL

  panel_SC <- pdata.frame(sampled_SC,index = c("cell_ID","year_index")) 
  panel_DC <- pdata.frame(sampled_DC,index = c("cell_ID","year_index")) 

  SC_output <- plm(plant ~ onset + lat + region + year_index, data = panel_SC, model = "random")
  DC_output <- plm(plant ~ onset + lat + region + year_index, data = panel_DC, model = "random")
  
  SC_onset <- summary(SC_output)$coefficients['onset',]['Estimate']
  SC_onset_stderr <- summary(SC_output)$coefficients['onset',]['Std. Error']
  DC_onset <- summary(DC_output)$coefficients['onset',]['Estimate']
  DC_onset_stderr <- summary(DC_output)$coefficients['onset',]['Std. Error']
  
  updated_results <- data.frame(plant_stat_type = c(plant_stat_type, plant_stat_type),
                                intensity = c("SC", "DC"),
                                model_type = c("RE", "RE"),
                                onset_coef = c(as.numeric(SC_onset), as.numeric(DC_onset)),
                                onset_std_err = c(as.numeric(SC_onset_stderr), as.numeric(DC_onset_stderr)),
                                year_treatment = c('panel_reg', 'panel_reg'),
                                lat_treatment = c('reg', 'reg'),
                                region_treatment = c('reg', 'reg'),
                                cell_treatment = c('panel', 'panel'))
  re_results <- rbind(re_results, updated_results)
}

############# model for (1) cell_ID as FE in panel, (2) onset, region, lat, year_index as predictor ####################################
for (plant_stat_type in plant_stat_types) {
  sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = 0.75, 
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_SC) <- NULL
  
  sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = 0.75, 
                   lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_DC) <- NULL

  panel_SC <- pdata.frame(sampled_SC,index = c("cell_ID")) 
  panel_DC <- pdata.frame(sampled_DC,index = c("cell_ID")) 

  SC_output <- plm(plant ~ onset + lat + region + year_index, data = panel_SC, model = "random")
  DC_output <- plm(plant ~ onset + lat + region + year_index, data = panel_DC, model = "random")
  
  SC_onset <- summary(SC_output)$coefficients['onset',]['Estimate']
  SC_onset_stderr <- summary(SC_output)$coefficients['onset',]['Std. Error']
  DC_onset <- summary(DC_output)$coefficients['onset',]['Estimate']
  DC_onset_stderr <- summary(DC_output)$coefficients['onset',]['Std. Error']
  
  updated_results <- data.frame(plant_stat_type = c(plant_stat_type, plant_stat_type),
                                intensity = c("SC", "DC"),
                                model_type = c("RE", "RE"),
                                onset_coef = c(as.numeric(SC_onset), as.numeric(DC_onset)),
                                onset_std_err = c(as.numeric(SC_onset_stderr), as.numeric(DC_onset_stderr)),
                                year_treatment = c('reg', 'reg'),
                                lat_treatment = c('reg', 'reg'),
                                region_treatment = c('reg', 'reg'),
                                cell_treatment = c('panel', 'panel'))
  re_results <- rbind(re_results, updated_results)
}

print(re_results)
```

## ME model

```{r}

library(lme4) # for lmer()
library(nlme) # for lme()

# sample from full data and turn into data frame
# sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = "median", grid_size = 0.75,
#                  lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
# st_geometry(sampled_SC) <- NULL
# 
# sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = "median", grid_size = 0.75,
#                  lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
# st_geometry(sampled_DC) <- NULL
# 
# # ME
# me_result_SC <- lmer(plant ~ onset + year_index + (1|cell_ID), data = sampled_SC)
# me_result_DC <- lmer(plant ~ onset + year_index + (1|cell_ID), data = sampled_DC)
# 
# print(me_result_SC)
# print(me_result_DC)
#
# # another ME. do nested models to look at effect of additional random effects
# me2_result_SC <- lmer(plant ~ onset + year_index + (1|lat), data = sampled_SC, REML = FALSE)
# me3_result_SC <- lmer(plant ~ onset + year_index + (1|region) + (1|cell_ID), data = sampled_SC, REML = FALSE)
# anova(me2_result_SC, me3_result_SC)

# another ME
#me2_result_SC <- lme(plant ~ onset + year_index, random = ~1|, data = sampled_SC, method = "ML")
#me2_complex_result_SC <- lme(plant ~ onset + year_index, random = ~1|cell_ID, data = sampled_SC, method = "ML")
#anova(me2_result_SC, me2_complex_result_SC)

# set up data frame to store model results for all models
me_results <- data.frame(plant_stat_type = numeric(0),
                      intensity = numeric(0),
                      model_type = numeric(0),
                      onset_coef = numeric(0),
                      onset_std_err = numeric(0),
                      year_treatment = character(0),
                      lat_treatment = character(0),
                      region_treatment = character(0),
                      cell_treatment = character(0),
                      model_type = character(0))

############# model for (1) FE: onset, year, lat, region (2) RE: cell_ID ####################################
for (plant_stat_type in plant_stat_types) {
  sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = 0.75, 
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_SC) <- NULL
  
  sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = 0.75, 
                   lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_DC) <- NULL

  SC_output <- lmer(plant ~ onset + year_index + lat + region + (1|cell_ID), data = sampled_SC)
  DC_output <- lmer(plant ~ onset + year_index + lat + region + (1|cell_ID), data = sampled_DC)
  
  SC_onset <- summary(SC_output)$coefficients['onset',]['Estimate']
  SC_onset_stderr <- summary(SC_output)$coefficients['onset',]['Std. Error']
  DC_onset <- summary(DC_output)$coefficients['onset',]['Estimate']
  DC_onset_stderr <- summary(DC_output)$coefficients['onset',]['Std. Error']
  
  updated_results <- data.frame(plant_stat_type = c(plant_stat_type, plant_stat_type),
                                intensity = c("SC", "DC"),
                                model_type = c("ME", "ME"),
                                onset_coef = c(as.numeric(SC_onset), as.numeric(DC_onset)),
                                onset_std_err = c(as.numeric(SC_onset_stderr), as.numeric(DC_onset_stderr)),
                                year_treatment = c('reg', 'reg'),
                                lat_treatment = c('reg', 'reg'),
                                region_treatment = c('reg', 'reg'),
                                cell_treatment = c('RE', 'RE'))
  me_results <- rbind(me_results, updated_results)
}

############# model for (1) FE: onset, year, lat (2) RE: cell_ID, region ####################################
for (plant_stat_type in plant_stat_types) {
  sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = 0.75, 
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_SC) <- NULL
  
  sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = 0.75, 
                   lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_DC) <- NULL

  SC_output <- lmer(plant ~ onset + year_index + lat + (1|region) + (1|cell_ID), data = sampled_SC)
  DC_output <- lmer(plant ~ onset + year_index + lat + (1|region) + (1|cell_ID), data = sampled_DC)
  
  SC_onset <- summary(SC_output)$coefficients['onset',]['Estimate']
  SC_onset_stderr <- summary(SC_output)$coefficients['onset',]['Std. Error']
  DC_onset <- summary(DC_output)$coefficients['onset',]['Estimate']
  DC_onset_stderr <- summary(DC_output)$coefficients['onset',]['Std. Error']
  
  updated_results <- data.frame(plant_stat_type = c(plant_stat_type, plant_stat_type),
                                intensity = c("SC", "DC"),
                                model_type = c("ME", "ME"),
                                onset_coef = c(as.numeric(SC_onset), as.numeric(DC_onset)),
                                onset_std_err = c(as.numeric(SC_onset_stderr), as.numeric(DC_onset_stderr)),
                                year_treatment = c('reg', 'reg'),
                                lat_treatment = c('reg', 'reg'),
                                region_treatment = c('RE', 'RE'),
                                cell_treatment = c('RE', 'RE'))
  me_results <- rbind(me_results, updated_results)
}

############# model for (1) FE: onset, year, lat (2) RE: region ####################################
for (plant_stat_type in plant_stat_types) {
  sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = 0.75, 
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_SC) <- NULL
  
  sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = 0.75, 
                   lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_DC) <- NULL

  SC_output <- lmer(plant ~ onset + year_index + lat + (1|region), data = sampled_SC)
  DC_output <- lmer(plant ~ onset + year_index + lat + (1|region), data = sampled_DC)
  
  SC_onset <- summary(SC_output)$coefficients['onset',]['Estimate']
  SC_onset_stderr <- summary(SC_output)$coefficients['onset',]['Std. Error']
  DC_onset <- summary(DC_output)$coefficients['onset',]['Estimate']
  DC_onset_stderr <- summary(DC_output)$coefficients['onset',]['Std. Error']
  
  updated_results <- data.frame(plant_stat_type = c(plant_stat_type, plant_stat_type),
                                intensity = c("SC", "DC"),
                                model_type = c("ME", "ME"),
                                onset_coef = c(as.numeric(SC_onset), as.numeric(DC_onset)),
                                onset_std_err = c(as.numeric(SC_onset_stderr), as.numeric(DC_onset_stderr)),
                                year_treatment = c('reg', 'reg'),
                                lat_treatment = c('reg', 'reg'),
                                region_treatment = c('RE', 'RE'),
                                cell_treatment = c('none', 'none'))
  me_results <- rbind(me_results, updated_results)
}

print(me_results)
```

## combine onset coef results and plot

```{r}

results <- rbind(ols_results, fe_results, re_results, me_results)

for (plant_stat_type in plant_stat_types) {
  for (intensity in c("SC", "DC")) {
    
    data <- results[results$intensity == intensity & results$plant_stat_type == plant_stat_type,]
    data_names <- c("OLS", "FE\nyear:\npanel", "FE\nyear:\npanel+reg", "FE\nyear:\nreg", # FE
                    "RE\nyear:\npanel", "RE\nyear:\npanel+reg", "RE\nyear:\nreg", # RE
                    "ME\nregion:\nreg\ncell:\nRE", "ME\nregion:\nRE\ncell:\nRE", "ME\nregion:\nRE\ncell:\nnone")
    data$model_type_specific <- data_names
    print(data)
    onset_plot <- ggplot(data = data, aes(x = model_type_specific)) +
      geom_point(aes(y = onset_coef, col = model_type)) +
      geom_errorbar(aes(ymin=onset_coef-onset_std_err, ymax=onset_coef+onset_std_err, col = model_type)) +
      theme(axis.text.y = element_blank(), axis.ticks = element_blank()) +
      ggtitle(paste('onset coef,', intensity, plant_stat_type)) +
      ylim(c(-0.2, 0.7)) +
      theme_bw()
    
    print(onset_plot)
  }
}
```

## try variations within ME

```{r}

# set up data frame to store model results for all models
me_results2 <- data.frame(plant_stat_type = numeric(0),
                      intensity = numeric(0),
                      model_type = numeric(0),
                      onset_coef = numeric(0),
                      onset_std_err = numeric(0),
                      year_treatment = character(0),
                      lat_treatment = character(0),
                      region_treatment = character(0),
                      cell_treatment = character(0),
                      model_type_specific = character(0))

############# model for different MEs, where the RE changes ####################################
for (plant_stat_type in plant_stat_types) {
  
  # for each plant stat type, try:
  # (1) region as RE
  # (2) lat as RE
  # (3) year as RE
  # (4) region + lat as RE
  # (5) region + year as RE
  # (6) lat + year as RE
  # (7) region + lat + year as RE
  
  sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = plant_stat_type, grid_size = 0.75, 
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_SC) <- NULL
  
  sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = plant_stat_type, grid_size = 0.75, 
                   lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
  st_geometry(sampled_DC) <- NULL

  # (1) region as RE
  SC_output_RE_region <- lmer(plant ~ onset + year_index + lat + (1|region), data = sampled_SC)
  DC_output_RE_region <- lmer(plant ~ onset + year_index + lat + (1|region), data = sampled_DC)
  
  SC_onset_RE_region <- summary(SC_output_RE_region)$coefficients['onset',]['Estimate']
  SC_onset_stderr_RE_region <- summary(SC_output_RE_region)$coefficients['onset',]['Std. Error']
  DC_onset_RE_region <- summary(DC_output_RE_region)$coefficients['onset',]['Estimate']
  DC_onset_stderr_RE_region <- summary(DC_output_RE_region)$coefficients['onset',]['Std. Error']
  
  # (2) lat as RE
  SC_output_RE_lat <- lmer(plant ~ onset + year_index + region + (1|lat), data = sampled_SC)
  DC_output_RE_lat <- lmer(plant ~ onset + year_index + region + (1|lat), data = sampled_DC)
  
  SC_onset_RE_lat <- summary(SC_output_RE_lat)$coefficients['onset',]['Estimate']
  SC_onset_stderr_RE_lat <- summary(SC_output_RE_lat)$coefficients['onset',]['Std. Error']
  DC_onset_RE_lat <- summary(DC_output_RE_lat)$coefficients['onset',]['Estimate']
  DC_onset_stderr_RE_lat <- summary(DC_output_RE_lat)$coefficients['onset',]['Std. Error']
  
  # (3) year as RE
  SC_output_RE_year <- lmer(plant ~ onset + lat + region + (1|year_index), data = sampled_SC)
  DC_output_RE_year <- lmer(plant ~ onset + lat + region + (1|year_index), data = sampled_DC)

  SC_onset_RE_year <- summary(SC_output_RE_year)$coefficients['onset',]['Estimate']
  SC_onset_stderr_RE_year <- summary(SC_output_RE_year)$coefficients['onset',]['Std. Error']
  DC_onset_RE_year <- summary(DC_output_RE_year)$coefficients['onset',]['Estimate']
  DC_onset_stderr_RE_year <- summary(DC_output_RE_year)$coefficients['onset',]['Std. Error']
  
  # (4) region + lat as RE
  SC_output_RE_region_lat <- lmer(plant ~ onset + year_index + (1|lat) + (1|region), data = sampled_SC)
  DC_output_RE_region_lat <- lmer(plant ~ onset + year_index + (1|lat) + (1|region), data = sampled_DC)
  
  SC_onset_RE_region_lat <- summary(SC_output_RE_region_lat)$coefficients['onset',]['Estimate']
  SC_onset_stderr_RE_region_lat <- summary(SC_output_RE_region_lat)$coefficients['onset',]['Std. Error']
  DC_onset_RE_region_lat<- summary(DC_output_RE_region_lat)$coefficients['onset',]['Estimate']
  DC_onset_stderr_RE_region_lat <- summary(DC_output_RE_region_lat)$coefficients['onset',]['Std. Error']
  
  # (5) region + year as RE
  SC_output_RE_region_year <- lmer(plant ~ onset + (1|year_index) + lat + (1|region), data = sampled_SC)
  DC_output_RE_region_year <- lmer(plant ~ onset + (1|year_index) + lat + (1|region), data = sampled_DC)
  
  SC_onset_RE_region_year <- summary(SC_output_RE_region_year)$coefficients['onset',]['Estimate']
  SC_onset_stderr_RE_region_year <- summary(SC_output_RE_region_year)$coefficients['onset',]['Std. Error']
  DC_onset_RE_region_year <- summary(DC_output_RE_region_year)$coefficients['onset',]['Estimate']
  DC_onset_stderr_RE_region_year <- summary(DC_output_RE_region_year)$coefficients['onset',]['Std. Error']
  
  # (6) lat + year as RE
  SC_output_RE_lat_year <- lmer(plant ~ onset + (1|year_index) + region + (1|lat), data = sampled_SC)
  DC_output_RE_lat_year <- lmer(plant ~ onset + (1|year_index) + region + (1|lat), data = sampled_DC)
  
  SC_onset_RE_lat_year <- summary(SC_output_RE_lat_year)$coefficients['onset',]['Estimate']
  SC_onset_stderr_RE_lat_year <- summary(SC_output_RE_lat_year)$coefficients['onset',]['Std. Error']
  DC_onset_RE_lat_year <- summary(DC_output_RE_lat_year)$coefficients['onset',]['Estimate']
  DC_onset_stderr_RE_lat_year <- summary(DC_output_RE_lat_year)$coefficients['onset',]['Std. Error']
  
  # (7) region + lat + year as RE
  SC_output_RE_region_lat_year <- lmer(plant ~ onset + (1|year_index) + (1|region) + (1|lat), data = sampled_SC)
  DC_output_RE_region_lat_year <- lmer(plant ~ onset + (1|year_index) + (1|region) + (1|lat), data = sampled_DC)
  
  SC_onset_RE_region_lat_year <- summary(SC_output_RE_region_lat_year)$coefficients['onset',]['Estimate']
  SC_onset_stderr_RE_region_lat_year <- summary(SC_output_RE_region_lat_year)$coefficients['onset',]['Std. Error']
  DC_onset_RE_region_lat_year <- summary(DC_output_RE_region_lat_year)$coefficients['onset',]['Estimate']
  DC_onset_stderr_RE_region_lat_year <- summary(DC_output_RE_region_lat_year)$coefficients['onset',]['Std. Error']
  
  updated_results <- data.frame(plant_stat_type = rep(plant_stat_type, 14), #c(plant_stat_type, plant_stat_type),
                                intensity = rep(c("SC", "DC"), 7),
                                model_type_specific = c("RE:\nregion", "RE:\nregion", # (1) region as RE
                                                        "RE:\nlat", "RE:\nlat", # (2) lat as RE
                                                        "RE:\nyear", "RE:\nyear", # (3) year as RE
                                                        "RE:\nregion\nlat", "RE:\nregion\nlat", # (4) region + lat as RE
                                                        "RE:\nregion\nyear", "RE:\nregion\nyear",  # (5) region + year as RE
                                                        "RE:\nlat\nyear", "RE:\nlat\nyear", # (6) lat + year as RE
                                                        "RE:\nregion\nlat\nyear", "RE:\nregion\nlat\nyear"), # (7) region + lat + year as RE
                                onset_coef = c(as.numeric(SC_onset_RE_region), as.numeric(DC_onset_RE_region), # (1) region as RE
                                               as.numeric(SC_onset_RE_lat), as.numeric(DC_onset_RE_lat), # (2) lat as RE
                                               as.numeric(SC_onset_RE_year), as.numeric(DC_onset_RE_year), # (3) year as RE
                                               as.numeric(SC_onset_RE_region_lat), as.numeric(DC_onset_RE_region_lat), # (4) region + lat as RE
                                               as.numeric(SC_onset_RE_region_year), as.numeric(DC_onset_RE_region_year), # (5) region + year as RE
                                               as.numeric(SC_onset_RE_lat_year), as.numeric(DC_onset_RE_lat_year), # (6) lat + year as RE
                                               as.numeric(SC_onset_RE_region_lat_year), as.numeric(DC_onset_RE_region_lat_year) # (7) region + lat + year as RE
                                               ),
                                onset_std_err = c(as.numeric(SC_onset_stderr_RE_region), as.numeric(DC_onset_stderr_RE_region), # (1) region as RE
                                               as.numeric(SC_onset_stderr_RE_lat), as.numeric(DC_onset_stderr_RE_lat), # (2) lat as RE
                                               as.numeric(SC_onset_stderr_RE_year), as.numeric(DC_onset_stderr_RE_year), # (3) year as RE
                                               as.numeric(SC_onset_stderr_RE_region_lat), as.numeric(DC_onset_stderr_RE_region_lat), # (4) region + lat as RE
                                               as.numeric(SC_onset_stderr_RE_region_year), as.numeric(DC_onset_stderr_RE_region_year), # (5) region + year as RE
                                               as.numeric(SC_onset_stderr_RE_lat_year), as.numeric(DC_onset_stderr_RE_lat_year), # (6) lat + year as RE
                                               as.numeric(SC_onset_stderr_RE_region_lat_year), as.numeric(DC_onset_stderr_RE_region_lat_year) # (7) region + lat + year as RE),
                                )
)
  me_results2 <- rbind(me_results2, updated_results)
}

for (plant_stat_type in plant_stat_types) {
  for (intensity in c("SC", "DC")) {
    
    data <- me_results2[me_results2$intensity == intensity & me_results2$plant_stat_type == plant_stat_type,]
    
    onset_plot <- ggplot(data = data, aes(x = model_type_specific)) +
      geom_point(aes(y = onset_coef)) +
      geom_errorbar(aes(ymin=onset_coef-onset_std_err, ymax=onset_coef+onset_std_err)) +
      theme(axis.text.y = element_blank(), axis.ticks = element_blank()) +
      ggtitle(paste('Mixed effects onset coef,', intensity, plant_stat_type)) +
      ylim(c(-0.2, 0.7)) +
      theme_bw()
    
    print(onset_plot)
  }
}

print(me_results2)

```

## testing ME specifications

```{r}
sampled_SC <- get_sampled_data(full_data = cell_sf_tidy_SC, plant_stat = "median", grid_size = 0.75, 
                 lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
st_geometry(sampled_SC) <- NULL
  
sampled_DC <- get_sampled_data(full_data = cell_sf_tidy_DC, plant_stat = "median", grid_size = 0.75, 
                  lat_offset = 0, lon_offset = 0, agg_scheme = FALSE, plot_samples = FALSE, year_oi = 2012)
st_geometry(sampled_DC) <- NULL

simple_model <- lmer(plant ~ onset + lat + (1|region) + year_index, data = sampled_DC, REML = FALSE)
complex_model <- lmer(plant ~ onset + (1|lat) + (1|region) + (1|year_index), data = sampled_DC, REML = FALSE)

anova(simple_model, complex_model)

summary(simple_model)
summary(complex_model)

ols_model <- lm(plant ~ onset + lat + region + year_index, data = sampled_DC)
  
```

## look at correlations between onset and other predictors

```{r}

all_DC_median <- cell_sf_tidy_DC[cell_sf_tidy_DC$plant_stat_type == "median",]

plot(all_DC_median$onset, all_DC_median$lat)

plot(all_DC_median$onset, all_DC_median$year_index)

ggplot(data = all_DC_median, aes(x = region, y = onset)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", size=2, color="red") +
  #geom_dotplot(binaxis='y', stackdir='center', dotsize=1) +
  theme_bw() +
  facet_wrap( ~ year)

ggplot(data = all_DC_median, aes(x = region, y = plant)) +
  geom_violin() +
  stat_summary(fun.y=median, geom="point", size=2, color="red") +
  #geom_dotplot(binaxis='y', stackdir='center', dotsize=1) +
  theme_bw() +
  facet_wrap( ~ year)

print(cor(all_DC_median$onset, all_DC_median$year_index))
print(cor(all_DC_median$onset, all_DC_median$lat))
```
## tests to compare models

```{r}


# FE vs OLS # if p value is small, have significant effects and use FE
print('FE vs OLS')
pFtest(fe_result_SC, ols_result_SC)
pFtest(fe_result_DC, ols_result_DC)

# RE vs OLS # if p value is small, have significant effects and use RE
print('RE vs OLS')
plmtest(ols_result_SC)
plmtest(ols_result_DC) 

# RE vs FE # if p value is small, one model is inconsistent, so do FE. Hausman test
print('RE vs FE')
phtest(re_result_SC, fe_result_SC)
phtest(re_result_DC, fe_result_DC)

# ME vs FE
print('ME vs FE')
anova(me_result_SC, fe_result_DC)
anova(me_result_DC, fe_result_DC)
```